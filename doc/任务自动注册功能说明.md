# ä»»åŠ¡è‡ªåŠ¨æ³¨å†ŒåŠŸèƒ½è¯´æ˜

## æ–‡æ¡£ä¿¡æ¯

- **åˆ›å»ºæ—¥æœŸ**: 2025-01-27
- **åŠŸèƒ½æ¨¡å—**: `com.lixiangyu.common.scheduler`
- **ç‰ˆæœ¬**: 1.0

---

## ä¸€ã€åŠŸèƒ½æ¦‚è¿°

### 1.1 æ ¸å¿ƒåŠŸèƒ½

å®ç°äº†åŸºäº Spring çš„ä»»åŠ¡è‡ªåŠ¨æ³¨å†Œæœºåˆ¶ï¼Œæ”¯æŒï¼š

1. âœ… **ç»Ÿä¸€ä»»åŠ¡æ¥å£**ï¼šå®šä¹‰ `Job` æ¥å£ï¼Œæ‰€æœ‰ä»»åŠ¡å¿…é¡»å®ç°
2. âœ… **é…ç½®æ³¨è§£**ï¼š`@ScheduledJob` æ³¨è§£æ”¯æŒçµæ´»é…ç½®
3. âœ… **è‡ªåŠ¨æ‰«æ**ï¼šåŸºäº Spring BeanPostProcessor è‡ªåŠ¨å‘ç°ä»»åŠ¡
4. âœ… **åŠ¨æ€æ³¨å†Œ**ï¼šè‡ªåŠ¨æ³¨å†Œåˆ° Quartz æˆ– XXL-Job
5. âœ… **é…ç½®åŠ è½½**ï¼šæ”¯æŒä»æ•°æ®åº“æˆ–æ³¨è§£åŠ è½½é…ç½®

### 1.2 å·¥ä½œæµç¨‹

```
åº”ç”¨å¯åŠ¨
    â†“
JobAutoRegister.init()
    â†“
æ‰«ææ‰€æœ‰ Job æ¥å£å®ç°ç±»
    â†“
æ£€æŸ¥ @ScheduledJob æ³¨è§£
    â†“
æ„å»ºä»»åŠ¡é…ç½®ï¼ˆä¼˜å…ˆä»æ•°æ®åº“åŠ è½½ï¼‰
    â†“
ä¿å­˜é…ç½®åˆ°æ•°æ®åº“
    â†“
æ³¨å†Œåˆ°è°ƒåº¦å™¨ï¼ˆQuartz/XXL-Jobï¼‰
    â†“
ä»»åŠ¡è‡ªåŠ¨å¯åŠ¨ï¼ˆå¦‚æœé…ç½®äº† autoStart=trueï¼‰
```

---

## äºŒã€æ ¸å¿ƒç»„ä»¶

### 2.1 Job æ¥å£

**ä½ç½®**ï¼š`com.lixiangyu.common.scheduler.core.Job`

**å®šä¹‰**ï¼š
```java
public interface Job {
    void execute(JobContext context) throws Exception;
}
```

**è¦æ±‚**ï¼š
- æ‰€æœ‰éœ€è¦è‡ªåŠ¨æ³¨å†Œçš„ä»»åŠ¡å¿…é¡»å®ç°æ­¤æ¥å£
- ä»»åŠ¡ç±»å¿…é¡»æ˜¯ Spring Beanï¼ˆä½¿ç”¨ @Component ç­‰æ³¨è§£ï¼‰

### 2.2 @ScheduledJob æ³¨è§£

**ä½ç½®**ï¼š`com.lixiangyu.common.scheduler.annotation.ScheduledJob`

**é…ç½®é¡¹**ï¼š

| é…ç½®é¡¹ | ç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| `jobName` | String | âœ… | - | ä»»åŠ¡åç§° |
| `jobGroup` | String | âŒ | "DEFAULT" | ä»»åŠ¡åˆ†ç»„ |
| `jobType` | JobType | âŒ | QUARTZ | ä»»åŠ¡ç±»å‹ |
| `cronExpression` | String | âŒ | "" | Cronè¡¨è¾¾å¼ |
| `description` | String | âŒ | "" | ä»»åŠ¡æè¿° |
| `autoStart` | boolean | âŒ | true | æ˜¯å¦è‡ªåŠ¨å¯åŠ¨ |
| `loadFromDatabase` | boolean | âŒ | true | æ˜¯å¦ä»æ•°æ®åº“åŠ è½½é…ç½® |
| `environment` | String | âŒ | "" | ç¯å¢ƒï¼ˆä»é…ç½®è¯»å–ï¼‰ |

### 2.3 JobAutoRegister

**ä½ç½®**ï¼š`com.lixiangyu.common.scheduler.core.JobAutoRegister`

**åŠŸèƒ½**ï¼š
- å®ç° `BeanPostProcessor`ï¼Œåœ¨ Bean åˆå§‹åŒ–åæ‰«æ
- å®ç° `ApplicationContextAware`ï¼Œè·å– Spring å®¹å™¨
- è‡ªåŠ¨å‘ç°å¹¶æ³¨å†Œæ‰€æœ‰å®ç°äº† `Job` æ¥å£çš„ Bean

### 2.4 JobExecutor

**ä½ç½®**ï¼š`com.lixiangyu.common.scheduler.core.JobExecutor`

**åŠŸèƒ½**ï¼š
- ç»Ÿä¸€çš„ä»»åŠ¡æ‰§è¡Œå…¥å£
- å¤„ç†ä»»åŠ¡æ‰§è¡Œã€æ—¥å¿—è®°å½•ã€é‡è¯•ç­‰
- åˆ›å»ºä»»åŠ¡æ‰§è¡Œä¸Šä¸‹æ–‡

---

## ä¸‰ã€ä½¿ç”¨æ–¹å¼

### 3.1 åŸºç¡€ä½¿ç”¨

**æ­¥éª¤ 1ï¼šå®ç° Job æ¥å£**

```java
@Component
@ScheduledJob(
        jobName = "myJob",
        jobGroup = "MY_GROUP",
        cronExpression = "0 0/10 * * * ?",
        description = "æˆ‘çš„ä»»åŠ¡"
)
public class MyJob implements Job {
    
    @Override
    public void execute(JobContext context) throws Exception {
        context.log("å¼€å§‹æ‰§è¡Œä»»åŠ¡");
        
        // ä¸šåŠ¡é€»è¾‘
        doSomething();
        
        context.log("ä»»åŠ¡æ‰§è¡Œå®Œæˆ");
    }
    
    private void doSomething() {
        // ä¸šåŠ¡å¤„ç†
    }
}
```

**æ­¥éª¤ 2ï¼šå¯åŠ¨åº”ç”¨**

åº”ç”¨å¯åŠ¨åï¼Œä»»åŠ¡ä¼šè‡ªåŠ¨æ³¨å†Œå¹¶å¯åŠ¨ï¼ˆå¦‚æœ `autoStart=true`ï¼‰ã€‚

### 3.2 ä»æ•°æ®åº“åŠ è½½é…ç½®

**åœºæ™¯**ï¼šä»»åŠ¡é…ç½®å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œéœ€è¦åŠ¨æ€æ›´æ–°ã€‚

**é…ç½®æ–¹å¼**ï¼š

```java
@Component
@ScheduledJob(
        jobName = "dynamicJob",
        jobGroup = "DYNAMIC",
        loadFromDatabase = true,  // ä»æ•°æ®åº“åŠ è½½é…ç½®
        autoStart = true
)
public class DynamicJob implements Job {
    
    @Override
    public void execute(JobContext context) throws Exception {
        // ä»»åŠ¡é€»è¾‘
    }
}
```

**æ•°æ®åº“é…ç½®**ï¼ˆ`scheduler_job_config` è¡¨ï¼‰ï¼š

| å­—æ®µ | å€¼ |
|------|-----|
| job_name | dynamicJob |
| job_group | DYNAMIC |
| cron_expression | 0 0/5 * * * ? |
| status | RUNNING |

**ä¼˜å…ˆçº§**ï¼š
1. æ•°æ®åº“é…ç½®ï¼ˆå¦‚æœ `loadFromDatabase=true`ï¼‰
2. æ³¨è§£é…ç½®ï¼ˆå¦‚æœæ•°æ®åº“ä¸­æ²¡æœ‰ï¼‰

### 3.3 ä»…ä½¿ç”¨æ³¨è§£é…ç½®

**åœºæ™¯**ï¼šä»»åŠ¡é…ç½®å›ºå®šï¼Œä¸éœ€è¦åŠ¨æ€ä¿®æ”¹ã€‚

```java
@Component
@ScheduledJob(
        jobName = "staticJob",
        jobGroup = "STATIC",
        cronExpression = "0 0 2 * * ?",  // æ¯å¤©å‡Œæ™¨2ç‚¹
        loadFromDatabase = false,  // ä¸ä»æ•°æ®åº“åŠ è½½
        autoStart = true
)
public class StaticJob implements Job {
    
    @Override
    public void execute(JobContext context) throws Exception {
        // ä»»åŠ¡é€»è¾‘
    }
}
```

### 3.4 ä»»åŠ¡å‚æ•°ä½¿ç”¨

**è·å–ä»»åŠ¡å‚æ•°**ï¼š

```java
@Override
public void execute(JobContext context) throws Exception {
    String jobParams = context.getJobParams();
    
    if (jobParams != null) {
        // è§£æ JSON å‚æ•°
        Map<String, Object> params = JSON.parseObject(jobParams, Map.class);
        String param1 = (String) params.get("param1");
        Integer param2 = (Integer) params.get("param2");
    }
}
```

**è®¾ç½®ä»»åŠ¡å‚æ•°**ï¼ˆåœ¨æ•°æ®åº“ä¸­ï¼‰ï¼š

```json
{
  "param1": "value1",
  "param2": 100
}
```

### 3.5 æ—¥å¿—è®°å½•

**ä½¿ç”¨ä¸Šä¸‹æ–‡è®°å½•æ—¥å¿—**ï¼š

```java
@Override
public void execute(JobContext context) throws Exception {
    context.log("å¼€å§‹å¤„ç†æ•°æ®");
    
    try {
        // ä¸šåŠ¡é€»è¾‘
        processData();
        context.log("æ•°æ®å¤„ç†å®Œæˆ");
    } catch (Exception e) {
        context.error("æ•°æ®å¤„ç†å¤±è´¥: " + e.getMessage());
        throw e;
    }
}
```

**æ—¥å¿—å­˜å‚¨**ï¼š
- è‡ªåŠ¨ä¿å­˜åˆ° `scheduler_job_log` è¡¨
- å¯é€šè¿‡ `JobLogService` æŸ¥è¯¢

---

## å››ã€é…ç½®ä¼˜å…ˆçº§

### 4.1 é…ç½®æ¥æº

1. **æ•°æ®åº“é…ç½®**ï¼ˆå¦‚æœ `loadFromDatabase=true`ï¼‰
2. **æ³¨è§£é…ç½®**ï¼ˆå¦‚æœæ•°æ®åº“ä¸­æ²¡æœ‰æˆ– `loadFromDatabase=false`ï¼‰
3. **é»˜è®¤å€¼**ï¼ˆå¦‚æœæ³¨è§£ä¸­æœªé…ç½®ï¼‰

### 4.2 é…ç½®åˆå¹¶è§„åˆ™

| é…ç½®é¡¹ | æ•°æ®åº“ | æ³¨è§£ | æœ€ç»ˆå€¼ |
|--------|--------|------|--------|
| jobName | âœ… | âœ… | æ•°æ®åº“ï¼ˆå¿…é¡»ä¸€è‡´ï¼‰ |
| jobGroup | âœ… | âœ… | æ•°æ®åº“ï¼ˆå¿…é¡»ä¸€è‡´ï¼‰ |
| cronExpression | âœ… | âœ… | æ•°æ®åº“ |
| jobType | âœ… | âœ… | æ•°æ®åº“ |
| description | âœ… | âœ… | æ•°æ®åº“ |
| retryCount | âœ… | - | æ•°æ®åº“ |
| retryInterval | âœ… | - | æ•°æ®åº“ |

---

## äº”ã€ä»»åŠ¡æ‰§è¡Œæµç¨‹

### 5.1 æ‰§è¡Œæµç¨‹

```
è°ƒåº¦å™¨è§¦å‘ä»»åŠ¡
    â†“
JobExecutor.execute()
    â†“
åˆ›å»ºæ‰§è¡Œæ—¥å¿—ï¼ˆRUNNINGï¼‰
    â†“
åˆ›å»ºä»»åŠ¡ä¸Šä¸‹æ–‡ï¼ˆJobContextï¼‰
    â†“
è·å–ä»»åŠ¡å®ä¾‹ï¼ˆä» Spring å®¹å™¨ï¼‰
    â†“
æ‰§è¡Œä»»åŠ¡ï¼ˆå¸¦é‡è¯•ï¼‰
    â†“
è®°å½•æ‰§è¡Œæ—¥å¿—
    â†“
æ›´æ–°æ‰§è¡Œæ—¥å¿—ï¼ˆSUCCESS/FAILEDï¼‰
    â†“
è§¦å‘å‘Šè­¦ï¼ˆå¦‚æœå¤±è´¥ï¼‰
```

### 5.2 é‡è¯•æœºåˆ¶

**é…ç½®**ï¼š
- `retryCount`ï¼šé‡è¯•æ¬¡æ•°ï¼ˆé»˜è®¤3æ¬¡ï¼‰
- `retryInterval`ï¼šé‡è¯•é—´éš”ï¼ˆé»˜è®¤60ç§’ï¼‰

**é‡è¯•é€»è¾‘**ï¼š
1. ä»»åŠ¡æ‰§è¡Œå¤±è´¥åï¼Œç­‰å¾… `retryInterval` ç§’
2. é‡æ–°æ‰§è¡Œä»»åŠ¡
3. æœ€å¤šé‡è¯• `retryCount` æ¬¡
4. å¦‚æœæ‰€æœ‰é‡è¯•éƒ½å¤±è´¥ï¼Œè®°å½•å¤±è´¥æ—¥å¿—å¹¶è§¦å‘å‘Šè­¦

---

## å…­ã€æœ€ä½³å®è·µ

### 6.1 ä»»åŠ¡è®¾è®¡

1. **å¹‚ç­‰æ€§**ï¼šç¡®ä¿ä»»åŠ¡å¯é‡å¤æ‰§è¡Œ
2. **å¼‚å¸¸å¤„ç†**ï¼šæ•è·å¹¶è®°å½•å¼‚å¸¸
3. **æ—¥å¿—è®°å½•**ï¼šä½¿ç”¨ `context.log()` è®°å½•å…³é”®æ­¥éª¤
4. **å‚æ•°éªŒè¯**ï¼šéªŒè¯ä»»åŠ¡å‚æ•°çš„æœ‰æ•ˆæ€§

### 6.2 é…ç½®ç®¡ç†

1. **ç¯å¢ƒéš”ç¦»**ï¼šä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒçš„é…ç½®
2. **é…ç½®ç‰ˆæœ¬**ï¼šé…ç½®å˜æ›´è®°å½•ç‰ˆæœ¬å·
3. **ç°åº¦å‘å¸ƒ**ï¼šé‡è¦é…ç½®å˜æ›´å…ˆç°åº¦åå…¨é‡

### 6.3 æ€§èƒ½ä¼˜åŒ–

1. **å¼‚æ­¥æ‰§è¡Œ**ï¼šè€—æ—¶ä»»åŠ¡ä½¿ç”¨å¼‚æ­¥æ–¹å¼
2. **æ‰¹é‡å¤„ç†**ï¼šæ‰¹é‡å¤„ç†æ•°æ®ï¼Œæé«˜æ•ˆç‡
3. **èµ„æºç®¡ç†**ï¼šåŠæ—¶é‡Šæ”¾èµ„æºï¼Œé¿å…å†…å­˜æ³„æ¼

---

## ä¸ƒã€ç¤ºä¾‹ä»£ç 

### 7.1 ç®€å•ä»»åŠ¡

```java
@Component
@ScheduledJob(
        jobName = "simpleJob",
        cronExpression = "0 0/5 * * * ?"
)
public class SimpleJob implements Job {
    
    @Override
    public void execute(JobContext context) throws Exception {
        System.out.println("æ‰§è¡Œç®€å•ä»»åŠ¡");
    }
}
```

### 7.2 å¤æ‚ä»»åŠ¡

```java
@Component
@ScheduledJob(
        jobName = "complexJob",
        jobGroup = "COMPLEX",
        cronExpression = "0 0 1 * * ?",
        description = "å¤æ‚ä»»åŠ¡ï¼šå¤„ç†å¤§é‡æ•°æ®",
        autoStart = true,
        loadFromDatabase = true
)
public class ComplexJob implements Job {
    
    @Autowired
    private DataService dataService;
    
    @Override
    public void execute(JobContext context) throws Exception {
        context.log("å¼€å§‹å¤„ç†æ•°æ®");
        
        try {
            // è·å–ä»»åŠ¡å‚æ•°
            String params = context.getJobParams();
            Map<String, Object> config = parseParams(params);
            
            // å¤„ç†æ•°æ®
            int count = dataService.processData(config);
            
            context.log("æ•°æ®å¤„ç†å®Œæˆï¼Œå¤„ç†æ•°é‡: " + count);
            
        } catch (Exception e) {
            context.error("æ•°æ®å¤„ç†å¤±è´¥: " + e.getMessage());
            throw e;
        }
    }
    
    private Map<String, Object> parseParams(String params) {
        if (params == null || params.isEmpty()) {
            return new HashMap<>();
        }
        return JSON.parseObject(params, Map.class);
    }
}
```

---

## å…«ã€æ³¨æ„äº‹é¡¹

### 8.1 ä»»åŠ¡ç±»è¦æ±‚

1. âœ… å¿…é¡»å®ç° `Job` æ¥å£
2. âœ… å¿…é¡»æ˜¯ Spring Beanï¼ˆä½¿ç”¨ @Component ç­‰æ³¨è§£ï¼‰
3. âœ… å¿…é¡»æ ‡æ³¨ `@ScheduledJob` æ³¨è§£
4. âœ… ä»»åŠ¡ç±»å¿…é¡»æ˜¯æ— çŠ¶æ€çš„ï¼ˆä¸èƒ½æœ‰å®ä¾‹å˜é‡ï¼‰

### 8.2 é…ç½®è¦æ±‚

1. âœ… `jobName` å¿…é¡»å”¯ä¸€ï¼ˆåœ¨åŒä¸€ `jobGroup` å’Œ `environment` ä¸‹ï¼‰
2. âœ… `cronExpression` å¿…é¡»æœ‰æ•ˆï¼ˆå¦‚æœä½¿ç”¨ Cron è°ƒåº¦ï¼‰
3. âœ… ä»»åŠ¡ç±»å¿…é¡»å­˜åœ¨ä¸”å¯å®ä¾‹åŒ–

### 8.3 æ‰§è¡Œè¦æ±‚

1. âœ… ä»»åŠ¡æ‰§è¡Œåº”è¯¥æ˜¯å¹‚ç­‰çš„
2. âœ… ä»»åŠ¡æ‰§è¡Œæ—¶é—´ä¸åº”è¿‡é•¿ï¼ˆå»ºè®® < 10åˆ†é’Ÿï¼‰
3. âœ… ä»»åŠ¡æ‰§è¡Œå¤±è´¥åº”æŠ›å‡ºå¼‚å¸¸

---

## ä¹ã€æ•…éšœæ’æŸ¥

### 9.1 ä»»åŠ¡æœªè‡ªåŠ¨æ³¨å†Œ

**æ£€æŸ¥é¡¹**ï¼š
1. ä»»åŠ¡ç±»æ˜¯å¦å®ç°äº† `Job` æ¥å£
2. ä»»åŠ¡ç±»æ˜¯å¦æ˜¯ Spring Bean
3. æ˜¯å¦æ ‡æ³¨äº† `@ScheduledJob` æ³¨è§£
4. æ£€æŸ¥æ—¥å¿—ä¸­æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯

### 9.2 ä»»åŠ¡æœªæ‰§è¡Œ

**æ£€æŸ¥é¡¹**ï¼š
1. ä»»åŠ¡çŠ¶æ€æ˜¯å¦ä¸º `RUNNING`
2. Cron è¡¨è¾¾å¼æ˜¯å¦æ­£ç¡®
3. è°ƒåº¦å™¨æ˜¯å¦æ­£å¸¸å¯åŠ¨
4. æ£€æŸ¥ä»»åŠ¡æ‰§è¡Œæ—¥å¿—

### 9.3 ä»»åŠ¡æ‰§è¡Œå¤±è´¥

**æ£€æŸ¥é¡¹**ï¼š
1. æŸ¥çœ‹ä»»åŠ¡æ‰§è¡Œæ—¥å¿—
2. æ£€æŸ¥ä»»åŠ¡å‚æ•°æ˜¯å¦æ­£ç¡®
3. æ£€æŸ¥ä¸šåŠ¡é€»è¾‘æ˜¯å¦æœ‰é—®é¢˜
4. æŸ¥çœ‹å‘Šè­¦ä¿¡æ¯

---

**ä»»åŠ¡è‡ªåŠ¨æ³¨å†ŒåŠŸèƒ½å·²å®Œæ•´å®ç°ï¼** ğŸ‰

