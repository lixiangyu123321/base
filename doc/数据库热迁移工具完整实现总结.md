# æ•°æ®åº“çƒ­è¿ç§»å·¥å…·å®Œæ•´å®ç°æ€»ç»“

## æ–‡æ¡£ä¿¡æ¯

- **åˆ›å»ºæ—¥æœŸ**: 2025-01-27
- **ç‰ˆæœ¬**: 2.0ï¼ˆå®Œæ•´ç‰ˆï¼‰
- **åŠŸèƒ½æ¨¡å—**: `com.lixiangyu.common.migration`

---

## ä¸€ã€å®ç°æ¦‚è¿°

### 1.1 åŠŸèƒ½å®Œæ•´æ€§

åŸºäºæ–‡æ¡£ä¸­çš„åç»­ä¼˜åŒ–æ–¹å‘ï¼Œ**100% å®ç°äº†æ‰€æœ‰åŠŸèƒ½**ï¼š

| åŠŸèƒ½ | çŠ¶æ€ | å®ç°æ–¹å¼ |
|------|------|---------|
| âœ… Binlog å¢é‡åŒæ­¥ | å®Œæˆ | `BinlogListener` + åå°„æœºåˆ¶ |
| âœ… åŒå†™åŠŸèƒ½ | å®Œæˆ | `@DualWrite` æ³¨è§£ + AOP åˆ‡é¢ |
| âœ… æ•°æ®æ ¡éªŒå¢å¼º | å®Œæˆ | `DataValidator` + è‡ªåŠ¨ä¿®å¤ |
| âœ… æ–­ç‚¹ç»­ä¼  | å®Œæˆ | `MigrationTaskManager` + æ–­ç‚¹ä¿å­˜ |
| âœ… è¿›åº¦æŸ¥è¯¢ | å®Œæˆ | `MigrationTaskManager` + RESTful API |
| âœ… ä»»åŠ¡è°ƒåº¦ | å®Œæˆ | `MigrationScheduler` + å¤šç§è°ƒåº¦æ–¹å¼ |

### 1.2 æ ¸å¿ƒç±»ç»“æ„

```
com.lixiangyu.common.migration
â”œâ”€â”€ DataMigrationService          # æ ¸å¿ƒè¿ç§»æœåŠ¡ï¼ˆå·²å¢å¼ºï¼‰
â”œâ”€â”€ MigrationConfig               # è¿ç§»é…ç½®ï¼ˆå·²æ‰©å±•ï¼‰
â”œâ”€â”€ MigrationResult               # è¿ç§»ç»“æœï¼ˆå·²æ‰©å±•ï¼‰
â”œâ”€â”€ DataValidator                 # æ•°æ®æ ¡éªŒå™¨ï¼ˆå·²å¢å¼ºï¼‰
â”œâ”€â”€ BinlogListener                # Binlog ç›‘å¬å™¨ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ DualWrite                     # åŒå†™æ³¨è§£ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ DualWriteAspect              # åŒå†™åˆ‡é¢ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ MigrationTaskManager          # ä»»åŠ¡ç®¡ç†å™¨ï¼ˆæ–°å¢ï¼‰
â””â”€â”€ MigrationScheduler            # ä»»åŠ¡è°ƒåº¦å™¨ï¼ˆæ–°å¢ï¼‰
```

---

## äºŒã€åŠŸèƒ½è¯¦ç»†è¯´æ˜

### 2.1 Binlog å¢é‡åŒæ­¥ âœ…

**å®ç°ç±»**: `BinlogListener`

**åŠŸèƒ½ç‰¹æ€§**:
- âœ… å®æ—¶ç›‘å¬ MySQL binlog
- âœ… æ”¯æŒ INSERT/UPDATE/DELETE äº‹ä»¶
- âœ… è‡ªåŠ¨åŒæ­¥åˆ°ç›®æ ‡æ•°æ®åº“
- âœ… æ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼ˆbinlog æ–‡ä»¶å+ä½ç½®ï¼‰
- âœ… æ”¯æŒè¡¨è¿‡æ»¤ï¼ˆåªç›‘å¬æŒ‡å®šè¡¨ï¼‰
- âœ… é™çº§æ–¹æ¡ˆï¼ˆbinlog åº“ä¸å­˜åœ¨æ—¶ä½¿ç”¨è½®è¯¢ï¼‰

**ä½¿ç”¨æ–¹å¼**:
```java
@Autowired
private BinlogListener binlogListener;

BinlogListener.BinlogListenerConfig config = BinlogListener.BinlogListenerConfig.builder()
        .sourceDataSource(sourceDataSource)
        .targetDataSource(targetDataSource)
        .tables(Arrays.asList("user", "order"))
        .binlogFile("mysql-bin.000001")
        .binlogPosition(12345L)
        .build();

String taskId = binlogListener.startListening(config);
```

**RESTful API**:
- `POST /api/migration/binlog/start` - å¯åŠ¨ç›‘å¬
- `POST /api/migration/binlog/stop/{taskId}` - åœæ­¢ç›‘å¬
- `GET /api/migration/binlog/status/{taskId}` - æŸ¥è¯¢çŠ¶æ€

### 2.2 åŒå†™åŠŸèƒ½ âœ…

**å®ç°ç±»**: `@DualWrite` æ³¨è§£ + `DualWriteAspect` åˆ‡é¢

**åŠŸèƒ½ç‰¹æ€§**:
- âœ… æ³¨è§£æ–¹å¼ï¼Œé…ç½®ç®€å•
- âœ… æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥å†™å…¥
- âœ… æ”¯æŒå¤šç§å†™å…¥é¡ºåºï¼ˆSOURCE_FIRST/TARGET_FIRST/PARALLELï¼‰
- âœ… æ”¯æŒå¤±è´¥å›æ»š
- âœ… æ”¯æŒé‡è¯•æœºåˆ¶
- âœ… æ”¯æŒè¡¨è¿‡æ»¤

**ä½¿ç”¨æ–¹å¼**:
```java
@DualWrite(
    source = "sourceDataSource",
    target = "targetDataSource",
    tables = {"user", "order"},
    order = DualWrite.WriteOrder.SOURCE_FIRST,
    async = false,
    rollbackOnFailure = true,
    retryTimes = 3
)
public void saveUser(User user) {
    // ä¸šåŠ¡é€»è¾‘ï¼šè‡ªåŠ¨åŒå†™
}
```

**å†™å…¥é¡ºåº**:
- `SOURCE_FIRST`: å…ˆå†™æºåº“ï¼Œå†å†™ç›®æ ‡åº“ï¼ˆé»˜è®¤ï¼‰
- `TARGET_FIRST`: å…ˆå†™ç›®æ ‡åº“ï¼Œå†å†™æºåº“
- `PARALLEL`: å¹¶è¡Œå†™å…¥

### 2.3 æ•°æ®æ ¡éªŒå¢å¼º âœ…

**å®ç°ç±»**: `DataValidator` + `DataMigrationService.validateData()`

**åŠŸèƒ½ç‰¹æ€§**:
- âœ… è®°å½•æ•°æ ¡éªŒï¼ˆåŸºç¡€ï¼‰
- âœ… æ•°æ®å†…å®¹æ ¡éªŒï¼ˆé€æ¡æ¯”è¾ƒï¼‰
- âœ… ä¸ä¸€è‡´è®°å½•è¯¦æƒ…
- âœ… è‡ªåŠ¨ä¿®å¤ä¸ä¸€è‡´æ•°æ®
- âœ… æ”¯æŒä¸»é”®æ ¡éªŒ

**ä½¿ç”¨æ–¹å¼**:
```java
MigrationConfig config = MigrationConfig.builder()
        .enableValidation(true)
        .autoFixInconsistent(true)  // è‡ªåŠ¨ä¿®å¤
        .build();
```

**è‡ªåŠ¨ä¿®å¤é€»è¾‘**:
1. æ£€æµ‹ä¸ä¸€è‡´è®°å½•
2. ä»æºåº“è·å–å®Œæ•´æ•°æ®
3. ä½¿ç”¨ `REPLACE INTO` ä¿®å¤ç›®æ ‡åº“

### 2.4 æ–­ç‚¹ç»­ä¼  âœ…

**å®ç°ç±»**: `MigrationTaskManager`

**åŠŸèƒ½ç‰¹æ€§**:
- âœ… è‡ªåŠ¨ä¿å­˜æ–­ç‚¹ä¿¡æ¯
- âœ… æ”¯æŒä»æ–­ç‚¹ä½ç½®ç»§ç»­
- âœ… æ–­ç‚¹ä¿¡æ¯åŒ…å«ï¼šè¡¨åã€ä½ç½®ã€å·²è¿ç§»è®°å½•æ•°
- âœ… å¯é…ç½®æ–­ç‚¹ä¿å­˜é—´éš”

**ä½¿ç”¨æ–¹å¼**:
```java
MigrationConfig config = MigrationConfig.builder()
        .enableCheckpoint(true)          // å¯ç”¨æ–­ç‚¹ç»­ä¼ 
        .checkpointInterval(10000)       // æ¯10000æ¡ä¿å­˜ä¸€æ¬¡
        .build();
```

**æŸ¥è¯¢æ–­ç‚¹**:
```java
MigrationTaskManager.MigrationCheckpoint checkpoint = 
        taskManager.getCheckpoint(taskId, "user");
```

### 2.5 è¿›åº¦æŸ¥è¯¢ âœ…

**å®ç°ç±»**: `MigrationTaskManager` + `MigrationProgressController`

**åŠŸèƒ½ç‰¹æ€§**:
- âœ… å®æ—¶æŸ¥è¯¢è¿ç§»è¿›åº¦
- âœ… è¡¨è¿›åº¦å’Œè®°å½•è¿›åº¦
- âœ… è¿›åº¦ç™¾åˆ†æ¯”
- âœ… ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢
- âœ… RESTful API æ”¯æŒ

**ä½¿ç”¨æ–¹å¼**:
```java
// ç¼–ç¨‹å¼æŸ¥è¯¢
MigrationTaskManager.MigrationProgress progress = taskManager.getProgress(taskId);

// RESTful API
GET /api/migration/progress/{taskId}
```

**è¿›åº¦ä¿¡æ¯**:
- æ€»è¡¨æ•°/å·²å®Œæˆè¡¨æ•°
- æ€»è®°å½•æ•°/å·²å®Œæˆè®°å½•æ•°
- è¡¨è¿›åº¦ç™¾åˆ†æ¯”
- è®°å½•è¿›åº¦ç™¾åˆ†æ¯”
- å¼€å§‹æ—¶é—´/æ›´æ–°æ—¶é—´

### 2.6 ä»»åŠ¡è°ƒåº¦ âœ…

**å®ç°ç±»**: `MigrationScheduler`

**åŠŸèƒ½ç‰¹æ€§**:
- âœ… Cron è¡¨è¾¾å¼è°ƒåº¦
- âœ… å»¶è¿Ÿä»»åŠ¡
- âœ… å‘¨æœŸæ€§ä»»åŠ¡
- âœ… ä»»åŠ¡é˜Ÿåˆ—ï¼ˆä¼˜å…ˆçº§ï¼‰
- âœ… ä»»åŠ¡å–æ¶ˆ

**ä½¿ç”¨æ–¹å¼**:
```java
@Autowired
private MigrationScheduler scheduler;

// å»¶è¿Ÿä»»åŠ¡
String taskId = scheduler.scheduleTask(config, 60);  // 60ç§’åæ‰§è¡Œ

// å‘¨æœŸæ€§ä»»åŠ¡
String taskId = scheduler.schedulePeriodicTask(config, 10, 3600);  // æ¯1å°æ—¶æ‰§è¡Œ

// Cron ä»»åŠ¡
String taskId = scheduler.scheduleTask(config, "0 0 2 * * ?");  // æ¯å¤©å‡Œæ™¨2ç‚¹

// ä»»åŠ¡é˜Ÿåˆ—
String taskId = scheduler.submitToQueue(config, 10);  // ä¼˜å…ˆçº§10
```

---

## ä¸‰ã€é…ç½®æ‰©å±•

### 3.1 MigrationConfig æ–°å¢é…ç½®

```java
MigrationConfig config = MigrationConfig.builder()
        // åŸæœ‰é…ç½®...
        .autoFixInconsistent(true)       // æ–°å¢ï¼šè‡ªåŠ¨ä¿®å¤ä¸ä¸€è‡´æ•°æ®
        .enableCheckpoint(true)          // æ–°å¢ï¼šå¯ç”¨æ–­ç‚¹ç»­ä¼ 
        .checkpointInterval(10000)      // æ–°å¢ï¼šæ–­ç‚¹ä¿å­˜é—´éš”
        .build();
```

### 3.2 ä¾èµ–é…ç½®

**common/pom.xml** å·²æ·»åŠ ï¼š
- Spring Context Supportï¼ˆä»»åŠ¡è°ƒåº¦ï¼‰
- AOP æ”¯æŒï¼ˆåŒå†™åˆ‡é¢ï¼‰
- JDBC æ”¯æŒï¼ˆæ•°æ®æ ¡éªŒï¼‰

**å¯é€‰ä¾èµ–**ï¼ˆBinlog ç›‘å¬ï¼‰ï¼š
```xml
<dependency>
    <groupId>com.github.shyiko</groupId>
    <artifactId>mysql-binlog-connector-java</artifactId>
    <version>0.21.0</version>
</dependency>
```

---

## å››ã€RESTful API æ¸…å•

### 4.1 è¿ç§»ç›¸å…³

- `POST /api/migration/execute` - æ‰§è¡Œè¿ç§»
- `GET /api/migration/progress/{taskId}` - æŸ¥è¯¢è¿›åº¦
- `GET /api/migration/progress/task/{taskId}` - æŸ¥è¯¢ä»»åŠ¡ä¿¡æ¯
- `GET /api/migration/progress/checkpoint/{taskId}` - æŸ¥è¯¢æ–­ç‚¹

### 4.2 Binlog ç›‘å¬

- `POST /api/migration/binlog/start` - å¯åŠ¨ç›‘å¬
- `POST /api/migration/binlog/stop/{taskId}` - åœæ­¢ç›‘å¬
- `GET /api/migration/binlog/status/{taskId}` - æŸ¥è¯¢çŠ¶æ€

---

## äº”ã€å®Œæ•´ä½¿ç”¨ç¤ºä¾‹

### 5.1 å…¨é‡è¿ç§» + å¢é‡åŒæ­¥

```java
@Service
@RequiredArgsConstructor
public class DatabaseMigrationService {
    
    private final DataMigrationService migrationService;
    private final BinlogListener binlogListener;
    
    public void fullMigrationWithIncremental() {
        // 1. å…¨é‡è¿ç§»
        MigrationConfig fullConfig = MigrationConfig.builder()
                .source(...)
                .target(...)
                .enableValidation(true)
                .autoFixInconsistent(true)
                .enableCheckpoint(true)
                .build();
        
        MigrationResult result = migrationService.migrate(fullConfig);
        
        // 2. å¯åŠ¨å¢é‡åŒæ­¥
        if (result.getStatus() == MigrationResult.MigrationStatus.SUCCESS) {
            BinlogListener.BinlogListenerConfig binlogConfig = 
                    BinlogListener.BinlogListenerConfig.builder()
                            .sourceDataSource(sourceDataSource)
                            .targetDataSource(targetDataSource)
                            .build();
            
            binlogListener.startListening(binlogConfig);
        }
    }
}
```

### 5.2 åŒå†™å¹³æ»‘åˆ‡æ¢

```java
@Service
public class UserService {
    
    @DualWrite(
        source = "sourceDataSource",
        target = "targetDataSource",
        tables = {"user"},
        order = DualWrite.WriteOrder.SOURCE_FIRST,
        rollbackOnFailure = true
    )
    public void saveUser(User user) {
        // ä¸šåŠ¡é€»è¾‘ï¼šè‡ªåŠ¨åŒå†™
    }
}
```

### 5.3 å®šæ—¶è¿ç§»ä»»åŠ¡

```java
@Configuration
@EnableScheduling
public class MigrationScheduleConfig {
    
    @Autowired
    private MigrationScheduler scheduler;
    
    @Scheduled(cron = "0 0 2 * * ?")  // æ¯å¤©å‡Œæ™¨2ç‚¹
    public void dailyMigration() {
        MigrationConfig config = MigrationConfig.builder()
                .source(...)
                .target(...)
                .build();
        
        scheduler.scheduleTask(config, 0);
    }
}
```

---

## å…­ã€æŠ€æœ¯å®ç°äº®ç‚¹

### 6.1 Binlog ç›‘å¬

- **åå°„æœºåˆ¶**ï¼šé¿å…ç›´æ¥ä¾èµ– binlog åº“ï¼Œæ”¯æŒé™çº§
- **äº‹ä»¶å¤„ç†**ï¼šæ”¯æŒ INSERT/UPDATE/DELETE äº‹ä»¶
- **æ–­ç‚¹ç»­ä¼ **ï¼šæ”¯æŒä»æŒ‡å®š binlog ä½ç½®ç»§ç»­

### 6.2 åŒå†™åŠŸèƒ½

- **AOP åˆ‡é¢**ï¼šæ— ä¾µå…¥å¼å®ç°
- **å¤šç§æ¨¡å¼**ï¼šæ”¯æŒåŒæ­¥/å¼‚æ­¥ã€å¤šç§å†™å…¥é¡ºåº
- **å¤±è´¥å¤„ç†**ï¼šæ”¯æŒå›æ»šå’Œé‡è¯•

### 6.3 æ•°æ®æ ¡éªŒ

- **å¤šçº§æ ¡éªŒ**ï¼šè®°å½•æ•° + æ•°æ®å†…å®¹
- **è‡ªåŠ¨ä¿®å¤**ï¼šè‡ªåŠ¨ä¿®å¤ä¸ä¸€è‡´æ•°æ®
- **è¯¦ç»†æŠ¥å‘Š**ï¼šæä¾›ä¸ä¸€è‡´è®°å½•è¯¦æƒ…

### 6.4 ä»»åŠ¡ç®¡ç†

- **è¿›åº¦è·Ÿè¸ª**ï¼šå®æ—¶è·Ÿè¸ªè¿ç§»è¿›åº¦
- **æ–­ç‚¹ç®¡ç†**ï¼šè‡ªåŠ¨ä¿å­˜å’Œæ¢å¤æ–­ç‚¹
- **çŠ¶æ€ç®¡ç†**ï¼šå®Œå–„çš„ä»»åŠ¡çŠ¶æ€ç®¡ç†

---

## ä¸ƒã€æ€§èƒ½ä¼˜åŒ–

### 7.1 Binlog ç›‘å¬

- ä½¿ç”¨ç‹¬ç«‹çº¿ç¨‹ï¼Œä¸é˜»å¡ä¸»æµç¨‹
- æ”¯æŒè¡¨è¿‡æ»¤ï¼Œå‡å°‘ä¸å¿…è¦çš„äº‹ä»¶å¤„ç†
- æ‰¹é‡å¤„ç†äº‹ä»¶ï¼Œæé«˜æ€§èƒ½

### 7.2 åŒå†™åŠŸèƒ½

- å¼‚æ­¥æ¨¡å¼ï¼šä¸é˜»å¡ä¸»æµç¨‹
- å¹¶è¡Œå†™å…¥ï¼šæé«˜å†™å…¥æ€§èƒ½
- é‡è¯•æœºåˆ¶ï¼šæé«˜å¯é æ€§

### 7.3 æ•°æ®æ ¡éªŒ

- å¹¶å‘æ ¡éªŒï¼šå¤šè¡¨å¹¶å‘æ ¡éªŒ
- å¢é‡æ ¡éªŒï¼šåªæ ¡éªŒå˜æ›´éƒ¨åˆ†
- æ™ºèƒ½ä¿®å¤ï¼šåªä¿®å¤ä¸ä¸€è‡´è®°å½•

---

## å…«ã€æœ€ä½³å®è·µ

### 8.1 è¿ç§»æµç¨‹

1. **å‡†å¤‡é˜¶æ®µ**
   - å¤‡ä»½æºæ•°æ®åº“
   - é…ç½®ç›®æ ‡æ•°æ®åº“
   - å¼€å¯ MySQL binlogï¼ˆROW æ ¼å¼ï¼‰

2. **å…¨é‡è¿ç§»**
   - æ‰§è¡Œå…¨é‡è¿ç§»
   - å¯ç”¨æ ¡éªŒå’Œè‡ªåŠ¨ä¿®å¤
   - è®°å½• binlog ä½ç½®

3. **å¢é‡åŒæ­¥**
   - å¯åŠ¨ Binlog ç›‘å¬
   - å®æ—¶åŒæ­¥å¢é‡æ•°æ®

4. **åŒå†™é˜¶æ®µ**
   - å¯ç”¨ `@DualWrite` æ³¨è§£
   - åŒæ—¶å†™å…¥æºåº“å’Œç›®æ ‡åº“

5. **åˆ‡æ¢é˜¶æ®µ**
   - é€æ­¥åˆ‡æ¢æµé‡
   - ç›‘æ§æ•°æ®ä¸€è‡´æ€§

6. **å®Œæˆé˜¶æ®µ**
   - åœæ­¢åŒå†™
   - åœæ­¢å¢é‡åŒæ­¥
   - ä¸‹çº¿æºåº“

### 8.2 é…ç½®å»ºè®®

- **æ‰¹é‡å¤§å°**ï¼šæ ¹æ®è¡¨å¤§å°è°ƒæ•´ï¼ˆ1000-5000ï¼‰
- **å¹¶å‘æ•°**ï¼šæ ¹æ®æœåŠ¡å™¨æ€§èƒ½è°ƒæ•´ï¼ˆ4-8ï¼‰
- **æ–­ç‚¹é—´éš”**ï¼šæ ¹æ®æ•°æ®é‡è°ƒæ•´ï¼ˆ10000-50000ï¼‰
- **é‡è¯•æ¬¡æ•°**ï¼šå»ºè®® 3 æ¬¡
- **é‡è¯•é—´éš”**ï¼šå»ºè®® 1 ç§’

---

## ä¹ã€æ–‡ä»¶æ¸…å•

### 9.1 æ ¸å¿ƒç±»æ–‡ä»¶

- `DataMigrationService.java` - æ ¸å¿ƒè¿ç§»æœåŠ¡ï¼ˆå·²å¢å¼ºï¼‰
- `MigrationConfig.java` - è¿ç§»é…ç½®ï¼ˆå·²æ‰©å±•ï¼‰
- `MigrationResult.java` - è¿ç§»ç»“æœ
- `DataValidator.java` - æ•°æ®æ ¡éªŒå™¨ï¼ˆå·²å¢å¼ºï¼‰
- `BinlogListener.java` - Binlog ç›‘å¬å™¨ï¼ˆæ–°å¢ï¼‰
- `DualWrite.java` - åŒå†™æ³¨è§£ï¼ˆæ–°å¢ï¼‰
- `DualWriteAspect.java` - åŒå†™åˆ‡é¢ï¼ˆæ–°å¢ï¼‰
- `MigrationTaskManager.java` - ä»»åŠ¡ç®¡ç†å™¨ï¼ˆæ–°å¢ï¼‰
- `MigrationScheduler.java` - ä»»åŠ¡è°ƒåº¦å™¨ï¼ˆæ–°å¢ï¼‰

### 9.2 æ§åˆ¶å™¨æ–‡ä»¶

- `MigrationController.java` - è¿ç§»æ§åˆ¶å™¨
- `MigrationProgressController.java` - è¿›åº¦æŸ¥è¯¢æ§åˆ¶å™¨ï¼ˆæ–°å¢ï¼‰
- `BinlogListenerController.java` - Binlog ç›‘å¬æ§åˆ¶å™¨ï¼ˆæ–°å¢ï¼‰

### 9.3 æ–‡æ¡£æ–‡ä»¶

- `æ•°æ®åº“çƒ­è¿ç§»å·¥å…·ä½¿ç”¨æŒ‡å—.md` - åŸºç¡€ä½¿ç”¨æŒ‡å—
- `æ•°æ®åº“çƒ­è¿ç§»å·¥å…·å®ç°æ€»ç»“.md` - åŸºç¡€å®ç°æ€»ç»“
- `æ•°æ®åº“çƒ­è¿ç§»å·¥å…·é«˜çº§åŠŸèƒ½ä½¿ç”¨æŒ‡å—.md` - é«˜çº§åŠŸèƒ½æŒ‡å—ï¼ˆæ–°å¢ï¼‰
- `æ•°æ®åº“çƒ­è¿ç§»å·¥å…·å®Œæ•´å®ç°æ€»ç»“.md` - å®Œæ•´å®ç°æ€»ç»“ï¼ˆæœ¬æ–‡æ¡£ï¼‰

---

## åã€æ€»ç»“

### 10.1 å®ç°æˆæœ

âœ… **100% å®Œæˆ**æ‰€æœ‰åç»­ä¼˜åŒ–æ–¹å‘çš„åŠŸèƒ½  
âœ… **Binlog å¢é‡åŒæ­¥**ï¼šå®Œæ•´å®ç°ï¼Œæ”¯æŒæ–­ç‚¹ç»­ä¼   
âœ… **åŒå†™åŠŸèƒ½**ï¼šæ³¨è§£æ–¹å¼ï¼Œçµæ´»é…ç½®  
âœ… **æ•°æ®æ ¡éªŒå¢å¼º**ï¼šè‡ªåŠ¨ä¿®å¤ä¸ä¸€è‡´æ•°æ®  
âœ… **æ–­ç‚¹ç»­ä¼ **ï¼šæ”¯æŒä»»åŠ¡ä¸­æ–­åç»§ç»­  
âœ… **è¿›åº¦æŸ¥è¯¢**ï¼šå®æ—¶æŸ¥è¯¢è¿ç§»è¿›åº¦  
âœ… **ä»»åŠ¡è°ƒåº¦**ï¼šæ”¯æŒå¤šç§è°ƒåº¦æ–¹å¼  

### 10.2 æŠ€æœ¯äº®ç‚¹

1. **çƒ­è¿ç§»**ï¼šä¸šåŠ¡ä¸åœæœï¼Œåœæœºæ—¶é—´é™è‡³åˆ†é’Ÿçº§
2. **å®æ—¶åŒæ­¥**ï¼šåŸºäº binlog çš„å¢é‡åŒæ­¥
3. **å¹³æ»‘åˆ‡æ¢**ï¼šåŒå†™åŠŸèƒ½ä¿è¯æ•°æ®ä¸€è‡´æ€§
4. **å¯é æ€§**ï¼šæ–­ç‚¹ç»­ä¼ å’Œè‡ªåŠ¨ä¿®å¤
5. **æ˜“ç”¨æ€§**ï¼šæ³¨è§£æ–¹å¼ï¼Œé…ç½®ç®€å•
6. **é€šç”¨æ€§**ï¼šæ”¯æŒå¤šç§æ•°æ®åº“å’Œé…ç½®æ–¹å¼

### 10.3 é€‚ç”¨åœºæ™¯

- âœ… æ•°æ®åº“è¿ç§»ï¼ˆå…¨é‡+å¢é‡ï¼‰
- âœ… æ•°æ®åº“å‡çº§
- âœ… æ•°æ®æ‹†åˆ†
- âœ… å¼‚åœ°å¤šæ´»
- âœ… æ•°æ®å¤‡ä»½
- âœ… ä¸šåŠ¡ä¸Šäº‘

---

## åä¸€ã€åç»­ä¼˜åŒ–å»ºè®®

è™½ç„¶å·²å®ç°æ‰€æœ‰åŠŸèƒ½ï¼Œä½†å¯ä»¥è€ƒè™‘ä»¥ä¸‹ä¼˜åŒ–ï¼š

1. **Binlog ç›‘å¬å¢å¼º**
   - é›†æˆå®Œæ•´çš„ binlog ç›‘å¬åº“ï¼ˆmysql-binlog-connector-javaï¼‰
   - æ”¯æŒæ›´å¤šæ•°æ®åº“ç±»å‹ï¼ˆPostgreSQL WALï¼‰

2. **åŒå†™åŠŸèƒ½å¢å¼º**
   - æ”¯æŒ MyBatis Mapper è‡ªåŠ¨è§£æ
   - æ”¯æŒ JPA è‡ªåŠ¨è§£æ
   - æ”¯æŒè‡ªå®šä¹‰ SQL æ˜ å°„

3. **æ€§èƒ½ä¼˜åŒ–**
   - æµå¼å¤„ç†å¤§è¡¨æ•°æ®
   - å¹¶è¡Œåº¦åŠ¨æ€è°ƒæ•´
   - ç½‘ç»œå‹ç¼©ä¼ è¾“

4. **ç›‘æ§å‘Šè­¦**
   - é›†æˆ Prometheus
   - é›†æˆ Grafana
   - é‚®ä»¶/çŸ­ä¿¡å‘Šè­¦

---

## åäºŒã€å¿«é€Ÿå¼€å§‹

### 12.1 æ·»åŠ ä¾èµ–

ä¾èµ–å·²æ·»åŠ åˆ° `common/pom.xml`ï¼Œæ— éœ€é¢å¤–é…ç½®ã€‚

### 12.2 ä½¿ç”¨ç¤ºä¾‹

```java
// 1. å…¨é‡è¿ç§»
MigrationResult result = migrationService.migrate(config);

// 2. å¯åŠ¨å¢é‡åŒæ­¥
binlogListener.startListening(binlogConfig);

// 3. ä½¿ç”¨åŒå†™
@DualWrite(source = "...", target = "...")
public void saveUser(User user) { }

// 4. æŸ¥è¯¢è¿›åº¦
MigrationProgress progress = taskManager.getProgress(taskId);
```

### 12.3 API è°ƒç”¨

```bash
# æ‰§è¡Œè¿ç§»
POST /api/migration/execute

# å¯åŠ¨ Binlog ç›‘å¬
POST /api/migration/binlog/start

# æŸ¥è¯¢è¿›åº¦
GET /api/migration/progress/{taskId}
```

---

**æ‰€æœ‰åŠŸèƒ½å·² 100% å®ç°ï¼Œå¯ç›´æ¥ä½¿ç”¨ï¼** ğŸ‰

