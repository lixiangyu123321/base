# 可配置任务调度框架实现说明

## 文档信息

- **创建日期**: 2025-01-27
- **功能模块**: `com.lixiangyu.common.scheduler`
- **版本**: 1.0

---

## 一、功能概述

### 1.1 核心功能

基于 Quartz 和 XXL-Job 实现的可配置任务调度框架，具备以下特性：

1. ✅ **配置持久化**：所有任务配置持久化到数据库
2. ✅ **配置热加载**：配置变更实时生效，无需重启
3. ✅ **任务状态监控**：执行状态、日志记录、失败告警
4. ✅ **失败重试机制**：可配置的重试次数和间隔
5. ✅ **权限管控**：登录认证、角色授权
6. ✅ **灰度发布**：支持配置变更的灰度发布

### 1.2 技术架构

- **调度引擎**：Quartz + XXL-Job
- **配置存储**：MySQL 数据库
- **配置中心**：Nacos（可选）
- **权限管理**：基于角色的访问控制（RBAC）

---

## 二、数据库设计

### 2.1 核心表结构

#### 1. scheduler_job_config（任务配置表）

存储所有任务配置信息，包括：
- 任务基本信息（名称、分组、类型、执行类）
- 调度规则（Cron表达式）
- 任务参数（JSON格式）
- 重试配置（重试次数、间隔）
- 告警配置（告警类型、接收人）
- 灰度发布配置

#### 2. scheduler_job_log（任务执行日志表）

记录每次任务执行的详细信息：
- 执行时间、时长
- 执行状态（成功/失败/运行中）
- 错误信息
- 执行日志

#### 3. scheduler_job_alert（任务告警记录表）

记录告警发送历史：
- 告警类型（钉钉/企业微信/邮件）
- 告警内容
- 发送状态

#### 4. scheduler_gray_release（灰度发布记录表）

记录灰度发布历史：
- 版本信息
- 灰度百分比
- 发布状态

#### 5. scheduler_permission（权限管控表）

存储用户权限信息：
- 用户ID、用户名
- 角色（ADMIN/OPERATOR/VIEWER）
- 权限列表

#### 6. scheduler_config_change（配置变更记录表）

记录所有配置变更历史：
- 变更类型（创建/更新/删除）
- 变更前后配置对比
- 操作人、操作IP

---

## 三、核心功能实现

### 3.1 配置持久化

**实现方式**：
- 使用 MyBatis 将任务配置持久化到数据库
- 支持 JSON 格式的任务参数存储
- 支持枚举类型的自动转换

**关键类**：
- `JobConfig` - 任务配置实体
- `JobConfigMapper` - 数据访问接口
- `JobConfigService` - 配置服务接口
- `JobConfigServiceImpl` - 配置服务实现

### 3.2 配置热加载

**实现方式**：
- 监听数据库配置变更
- 使用 Nacos 配置中心推送变更（可选）
- 自动刷新调度器中的任务

**关键类**：
- `ConfigRefreshListener` - 配置刷新监听器
- `SchedulerManager` - 调度器管理器

### 3.3 任务状态监控

**实现方式**：
- 记录每次任务执行的详细信息
- 提供任务执行日志查询接口
- 实时监控任务执行状态

**关键类**：
- `JobLog` - 任务执行日志实体
- `JobLogService` - 日志服务接口

### 3.4 失败重试机制

**实现方式**：
- 任务执行失败后自动重试
- 可配置重试次数和重试间隔
- 支持指数退避策略

**配置项**：
- `retryCount` - 重试次数（默认3次）
- `retryInterval` - 重试间隔（默认60秒）

### 3.5 告警功能

**支持的告警方式**：
- 钉钉（DINGTALK）
- 企业微信（WECHAT）
- 邮件（EMAIL）

**告警触发条件**：
- 任务执行失败
- 任务执行超时
- 任务连续失败N次

**关键类**：
- `AlertService` - 告警服务接口
- `DingtalkAlertService` - 钉钉告警实现
- `WechatAlertService` - 企业微信告警实现
- `EmailAlertService` - 邮件告警实现

### 3.6 权限管控

**角色定义**：
- **ADMIN** - 管理员：所有权限
- **OPERATOR** - 操作员：任务管理权限
- **VIEWER** - 查看者：只读权限

**权限控制**：
- 接口级别的权限验证
- 基于注解的权限控制
- 操作日志记录

**关键类**：
- `PermissionService` - 权限服务接口
- `PermissionInterceptor` - 权限拦截器

### 3.7 灰度发布

**实现方式**：
- 配置变更时创建灰度发布记录
- 按百分比逐步发布
- 支持回滚

**灰度流程**：
1. 创建灰度发布记录
2. 设置灰度百分比（0-100）
3. 逐步增加灰度百分比
4. 验证通过后全量发布
5. 如有问题，支持回滚

**关键类**：
- `GrayReleaseService` - 灰度发布服务接口
- `GrayReleaseRecord` - 灰度发布记录实体

---

## 四、使用方式

### 4.1 创建任务配置

```java
JobConfig config = JobConfig.builder()
        .jobName("testJob")
        .jobGroup("DEFAULT")
        .jobType(JobConfig.JobType.QUARTZ)
        .jobClass("com.lixiangyu.job.TestJob")
        .cronExpression("0 0/5 * * * ?")
        .description("测试任务")
        .environment("dev")
        .retryCount(3)
        .retryInterval(60)
        .alertEnabled(true)
        .alertTypes(Arrays.asList(JobConfig.AlertType.DINGTALK))
        .alertReceivers(JobConfig.AlertReceivers.builder()
                .dingtalk(Arrays.asList("13800138000"))
                .build())
        .build();

jobConfigService.save(config);
```

### 4.2 启动任务

```java
// 配置保存后，调度器会自动加载并启动任务
// 也可以通过 API 手动启动
schedulerManager.addJob(config);
```

### 4.3 监控任务

```java
// 查询任务执行日志
List<JobLog> logs = jobLogService.listByJobId(jobId);

// 查询任务执行状态
JobConfig config = jobConfigService.getById(jobId);
JobConfig.JobStatus status = config.getStatus();
```

---

## 五、API 接口

### 5.1 任务配置管理

- `POST /api/scheduler/job/config` - 创建任务配置
- `PUT /api/scheduler/job/config/{id}` - 更新任务配置
- `DELETE /api/scheduler/job/config/{id}` - 删除任务配置
- `GET /api/scheduler/job/config/{id}` - 查询任务配置
- `GET /api/scheduler/job/config/list` - 查询任务配置列表

### 5.2 任务控制

- `POST /api/scheduler/job/{id}/start` - 启动任务
- `POST /api/scheduler/job/{id}/stop` - 停止任务
- `POST /api/scheduler/job/{id}/pause` - 暂停任务
- `POST /api/scheduler/job/{id}/resume` - 恢复任务

### 5.3 任务监控

- `GET /api/scheduler/job/{id}/logs` - 查询任务执行日志
- `GET /api/scheduler/job/{id}/status` - 查询任务状态
- `GET /api/scheduler/job/{id}/statistics` - 查询任务统计信息

### 5.4 灰度发布

- `POST /api/scheduler/gray/release` - 创建灰度发布
- `GET /api/scheduler/gray/release/{id}` - 查询灰度发布记录
- `POST /api/scheduler/gray/release/{id}/rollback` - 回滚灰度发布

---

## 六、配置说明

### 6.1 数据库配置

执行 `sql/scheduler_init.sql` 初始化数据库表结构。

### 6.2 依赖配置

在 `common/pom.xml` 中添加以下依赖（可选）：

```xml
<!-- Quartz 调度器 -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-quartz</artifactId>
</dependency>

<!-- XXL-Job 客户端 -->
<dependency>
    <groupId>com.xuxueli</groupId>
    <artifactId>xxl-job-core</artifactId>
    <version>2.4.0</version>
</dependency>
```

### 6.3 告警配置

在 `application.yml` 中配置告警参数：

```yaml
scheduler:
  alert:
    dingtalk:
      webhook: https://oapi.dingtalk.com/robot/send?access_token=xxx
    wechat:
      webhook: https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx
    email:
      smtp-host: smtp.example.com
      smtp-port: 587
      username: alert@example.com
      password: password
```

---

## 七、最佳实践

### 7.1 任务设计

1. **任务类设计**：实现 `Job` 接口，处理业务逻辑
2. **异常处理**：捕获并记录异常，触发告警
3. **幂等性**：确保任务可重复执行

### 7.2 配置管理

1. **环境隔离**：不同环境使用不同的配置
2. **版本控制**：配置变更记录版本号
3. **灰度发布**：重要配置变更先灰度后全量

### 7.3 监控告警

1. **告警阈值**：设置合理的告警阈值
2. **告警收敛**：避免告警风暴
3. **告警升级**：重要告警及时升级

---

## 八、后续优化

1. **任务依赖**：支持任务之间的依赖关系
2. **任务分片**：支持大任务的分片执行
3. **任务编排**：支持复杂任务流程编排
4. **性能优化**：优化大量任务场景下的性能

---

**框架已实现核心功能，可投入使用！** 🎉

