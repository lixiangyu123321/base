# æ•°æ®åº“æ“ä½œå™¨æ‰©å±•è¯´æ˜

## æ–‡æ¡£ä¿¡æ¯

- **åˆ›å»ºæ—¥æœŸ**: 2025-01-27
- **åŠŸèƒ½æ¨¡å—**: `com.lixiangyu.common.migration.operator`
- **ç‰ˆæœ¬**: 2.0

---

## ä¸€ã€é—®é¢˜è¯´æ˜

### 1.1 åŸæœ‰å®ç°

åŸæœ‰çš„ `DataMigrationService` åªæ”¯æŒ **JDBC åŸç”Ÿæ¥å£**æ“ä½œæ•°æ®åº“ï¼š

```java
// åŸæœ‰å®ç°ï¼šåªèƒ½ä½¿ç”¨ JDBC åŸç”Ÿæ¥å£
try (Connection conn = dataSource.getConnection();
     PreparedStatement stmt = conn.prepareStatement(sql)) {
    // æ“ä½œæ•°æ®åº“
}
```

**å±€é™æ€§**ï¼š
- âŒ åªèƒ½ä½¿ç”¨ JDBC åŸç”Ÿæ¥å£
- âŒ æ— æ³•åˆ©ç”¨ MyBatis çš„ç‰¹æ€§
- âŒ æ— æ³•ä½¿ç”¨ Spring JDBC Template çš„ä¾¿åˆ©æ€§
- âŒ æ‰©å±•æ€§å·®

### 1.2 æ‰©å±•æ–¹æ¡ˆ

é€šè¿‡**ç­–ç•¥æ¨¡å¼**å’Œ**å·¥å‚æ¨¡å¼**ï¼Œæ”¯æŒå¤šç§æ•°æ®åº“æ“ä½œæ–¹å¼ï¼š

| æ“ä½œæ–¹å¼ | å®ç°ç±» | è¯´æ˜ |
|---------|--------|------|
| **JDBC** | `JdbcDatabaseOperator` | JDBC åŸç”Ÿæ¥å£ï¼ˆé»˜è®¤ï¼‰ |
| **JDBC Template** | `JdbcTemplateDatabaseOperator` | Spring JDBC Template |
| **MyBatis** | `MyBatisDatabaseOperator` | MyBatis SqlSession |
| **JPA** | `JpaDatabaseOperator` | JPA EntityManager |

---

## äºŒã€æ¶æ„è®¾è®¡

### 2.1 ç±»ç»“æ„

```
DatabaseOperator (æ¥å£)
â”œâ”€â”€ JdbcDatabaseOperator (JDBC å®ç°)
â”œâ”€â”€ JdbcTemplateDatabaseOperator (JdbcTemplate å®ç°)
â”œâ”€â”€ MyBatisDatabaseOperator (MyBatis å®ç°)
â”‚   â””â”€â”€ SqlSessionTemplateWrapper (åŒ…è£…ç±»)
â”‚   â””â”€â”€ SqlSessionFactoryWrapper (åŒ…è£…ç±»)
â””â”€â”€ JpaDatabaseOperator (JPA å®ç°)
    â””â”€â”€ EntityManagerWrapper (åŒ…è£…ç±»)
    â””â”€â”€ EntityManagerFactoryWrapper (åŒ…è£…ç±»)

DatabaseOperatorFactory (å·¥å‚ç±»)
â””â”€â”€ æ ¹æ®é…ç½®åˆ›å»ºä¸åŒçš„æ“ä½œå™¨
```

### 2.2 æ ¸å¿ƒæ¥å£

```java
public interface DatabaseOperator {
    Connection getConnection();
    ResultSet executeQuery(String sql, Object... params);
    int executeUpdate(String sql, Object... params);
    int[] executeBatch(String sql, List<Object[]> batchParams);
    long getRecordCount(String tableName);
    TableStructure getTableStructure(String tableName);
    void createTable(String tableName, TableStructure structure);
    void truncateTable(String tableName);
    List<String> getPrimaryKeys(String tableName);
}
```

---

## ä¸‰ã€ä½¿ç”¨æ–¹å¼

### 3.1 é…ç½®æ“ä½œå™¨ç±»å‹

```java
MigrationConfig config = MigrationConfig.builder()
        .source(MigrationConfig.DataSourceConfig.builder()
                .dataSource(sourceDataSource)
                .operatorType(MigrationConfig.DataSourceConfig.OperatorType.JDBC)  // JDBC
                .build())
        .target(MigrationConfig.DataSourceConfig.builder()
                .dataSource(targetDataSource)
                .operatorType(MigrationConfig.DataSourceConfig.OperatorType.MYBATIS)  // MyBatis
                .build())
        .build();
```

### 3.2 æ“ä½œå™¨ç±»å‹è¯´æ˜

#### 3.2.1 JDBCï¼ˆé»˜è®¤ï¼‰

**ç‰¹ç‚¹**ï¼š
- âœ… æœ€åº•å±‚ï¼Œæ€§èƒ½æœ€å¥½
- âœ… ä¸ä¾èµ–å…¶ä»–æ¡†æ¶
- âŒ ä»£ç è¾ƒç¹ç

**é€‚ç”¨åœºæ™¯**ï¼š
- æ€§èƒ½è¦æ±‚é«˜çš„åœºæ™¯
- ä¸éœ€è¦ ORM æ¡†æ¶çš„åœºæ™¯

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
.operatorType(MigrationConfig.DataSourceConfig.OperatorType.JDBC)
```

#### 3.2.2 JDBC Template

**ç‰¹ç‚¹**ï¼š
- âœ… Spring æä¾›ï¼Œä½¿ç”¨æ–¹ä¾¿
- âœ… è‡ªåŠ¨å¤„ç†èµ„æºç®¡ç†
- âœ… æ”¯æŒå‘½åå‚æ•°

**é€‚ç”¨åœºæ™¯**ï¼š
- ä½¿ç”¨ Spring æ¡†æ¶çš„é¡¹ç›®
- éœ€è¦ç®€åŒ– JDBC ä»£ç çš„åœºæ™¯

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
.operatorType(MigrationConfig.DataSourceConfig.OperatorType.JDBC_TEMPLATE)
```

#### 3.2.3 MyBatis

**ç‰¹ç‚¹**ï¼š
- âœ… å¯ä»¥åˆ©ç”¨ MyBatis çš„ç‰¹æ€§
- âœ… æ”¯æŒ Mapper XML
- âœ… æ”¯æŒåŠ¨æ€ SQL

**é€‚ç”¨åœºæ™¯**ï¼š
- é¡¹ç›®å·²ä½¿ç”¨ MyBatis
- éœ€è¦åˆ©ç”¨ MyBatis ç‰¹æ€§çš„åœºæ™¯

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
.operatorType(MigrationConfig.DataSourceConfig.OperatorType.MYBATIS)
```

**æ³¨æ„**ï¼šå¦‚æœ MyBatis æœªé…ç½®ï¼Œä¼šè‡ªåŠ¨é™çº§ä¸º `JdbcTemplateDatabaseOperator`ã€‚

#### 3.2.4 JPA

**ç‰¹ç‚¹**ï¼š
- âœ… æ”¯æŒ JPA å®ä½“ç±»æ“ä½œ
- âœ… æ”¯æŒåŸç”Ÿ SQL æŸ¥è¯¢
- âœ… è‡ªåŠ¨äº‹åŠ¡ç®¡ç†
- âœ… ä½¿ç”¨ Wrapper åŒ…è£…ç±»ï¼Œç¼–è¯‘æœŸæ— ä¾èµ–

**é€‚ç”¨åœºæ™¯**ï¼š
- é¡¹ç›®å·²ä½¿ç”¨ JPA/Hibernate
- éœ€è¦åˆ©ç”¨ JPA ç‰¹æ€§çš„åœºæ™¯

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
.operatorType(MigrationConfig.DataSourceConfig.OperatorType.JPA)
```

**æ³¨æ„**ï¼šJPA æ“ä½œå™¨ä½¿ç”¨ Wrapper åŒ…è£…ç±»è®¾è®¡ï¼Œç¼–è¯‘æœŸä¸éœ€è¦ JPA ä¾èµ–ï¼Œè¿è¡ŒæœŸæŒ‰éœ€æä¾›ã€‚

---

## å››ã€å®ç°ç»†èŠ‚

### 4.1 å·¥å‚æ¨¡å¼

```java
@Component
public class DatabaseOperatorFactory {
    
    public DatabaseOperator createOperator(DataSource dataSource, OperatorType operatorType) {
        switch (operatorType) {
            case JDBC:
                return new JdbcDatabaseOperator(dataSource);
            case JDBC_TEMPLATE:
                return new JdbcTemplateDatabaseOperator(dataSource);
            case MYBATIS:
                // å°è¯•è·å– MyBatis Beanï¼Œå¤±è´¥åˆ™é™çº§
                return new MyBatisDatabaseOperator(...);
            case JPA:
                // å°è¯•è·å– JPAè§„èŒƒ.md Beanï¼Œä½¿ç”¨ Wrapper åŒ…è£…ç±»
                Object entityManager = applicationContext.getBean("entityManager");
                Object entityManagerFactory = applicationContext.getBean("entityManagerFactory");
                return new JpaDatabaseOperator(entityManager, entityManagerFactory, dataSource);
            default:
                return new JdbcDatabaseOperator(dataSource);
        }
    }
}
```

### 4.2 ç­–ç•¥æ¨¡å¼

`DataMigrationService` ä½¿ç”¨ `DatabaseOperator` æ¥å£ï¼Œä¸å…³å¿ƒå…·ä½“å®ç°ï¼š

```java
// è·å–æ“ä½œå™¨
DatabaseOperator sourceOperator = factory.createOperator(
        sourceDataSource, 
        config.getSource().getOperatorType()
);

DatabaseOperator targetOperator = factory.createOperator(
        targetDataSource, 
        config.getTarget().getOperatorType()
);

// ä½¿ç”¨æ“ä½œå™¨ï¼ˆä¸å…³å¿ƒå…·ä½“å®ç°ï¼‰
long count = sourceOperator.getRecordCount(tableName);
targetOperator.createTable(tableName, structure);
```

---

## äº”ã€Wrapper åŒ…è£…ç±»è®¾è®¡ä¼˜ç‚¹

åœ¨ `MyBatisDatabaseOperator` å’Œ `JpaDatabaseOperator` çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† **Wrapper åŒ…è£…ç±»**çš„è®¾è®¡æ¨¡å¼ï¼Œé€šè¿‡åå°„æœºåˆ¶å°è£…å¯¹ç¬¬ä¸‰æ–¹æ¡†æ¶ï¼ˆMyBatisã€JPAï¼‰çš„è°ƒç”¨ã€‚è¿™ç§è®¾è®¡å¸¦æ¥äº†ä»¥ä¸‹é‡è¦ä¼˜ç‚¹ï¼š

### 5.1 ç¼–è¯‘æœŸæ— ä¾èµ–ï¼Œè¿è¡ŒæœŸæŒ‰éœ€æä¾›

#### 5.1.1 è®¾è®¡åŸç†

**ç¼–è¯‘æœŸ**ï¼š
- ä»£ç ä¸­ä»…ä½¿ç”¨ `Object` ç±»å‹æ¥æ”¶ MyBatis/JPA å®ä¾‹
- åŒ…è£…ç±»å†…éƒ¨é€šè¿‡åå°„è°ƒç”¨æ¡†æ¶æ–¹æ³•ï¼ˆåå°„æ˜¯è¿è¡ŒæœŸè¡Œä¸ºï¼‰
- ç¼–è¯‘æ—¶ä¸éœ€è¦å¼•å…¥ MyBatis/JPA çš„ jar åŒ…
- ä¸ä¼šå‡ºç° "ç±»æ‰¾ä¸åˆ°" çš„ç¼–è¯‘é”™è¯¯

**è¿è¡ŒæœŸ**ï¼š
- å¦‚æœé¡¹ç›®å®é™…è¦ç”¨åˆ° MyBatis/JPA çš„èƒ½åŠ›ï¼Œéœ€è¦å¼•å…¥å¯¹åº”çš„ jar åŒ…
- å¦åˆ™åå°„è°ƒç”¨æ—¶ä¼šæŠ¥ "ç±»æ‰¾ä¸åˆ°" çš„è¿è¡Œæ—¶å¼‚å¸¸
- ä½†å¦‚æœé¡¹ç›®ä¸ç”¨è¿™äº›æ¡†æ¶ï¼ˆæ¯”å¦‚ç”¨å…¶ä»–æ¡†æ¶ï¼‰ï¼Œè¿™ä¸ªç±»ä¹Ÿèƒ½æ­£å¸¸ç¼–è¯‘å’ŒåŠ è½½
- åªè¦ä¸è°ƒç”¨ç›¸å…³çš„æ–¹æ³•ï¼Œå°±ä¸ä¼šè§¦å‘è¿è¡Œæ—¶å¼‚å¸¸

#### 5.1.2 å®é™…æ•ˆæœ

```java
// MyBatisDatabaseOperator æ„é€ å‡½æ•°
public MyBatisDatabaseOperator(Object sqlSessionFactory,  // â† ä½¿ç”¨ Objectï¼Œç¼–è¯‘æœŸæ— ä¾èµ–
                                Object sqlSessionTemplate,
                                DataSource dataSource) {
    // å†…éƒ¨é€šè¿‡åå°„è°ƒç”¨ï¼Œè¿è¡ŒæœŸæ‰éœ€è¦ MyBatis ç±»
    this.sqlSessionTemplateWrapper = new SqlSessionTemplateWrapper(sqlSessionTemplate);
}

// åŒ…è£…ç±»å†…éƒ¨ä½¿ç”¨åå°„
private static class SqlSessionTemplateWrapper {
    public Connection getConnection() {
        try {
            return (Connection) sqlSessionTemplate.getClass()  // â† åå°„è°ƒç”¨
                    .getMethod("getConnection")
                    .invoke(sqlSessionTemplate);
        } catch (Exception e) {
            throw new RuntimeException("è·å–è¿æ¥å¤±è´¥", e);
        }
    }
}
```

**ä¼˜åŠ¿**ï¼š
- âœ… `common` æ¨¡å—å¯ä»¥åœ¨æ²¡æœ‰ MyBatis/JPA ä¾èµ–çš„æƒ…å†µä¸‹ç¼–è¯‘é€šè¿‡
- âœ… é¡¹ç›®å¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©æ€§åœ°å¼•å…¥æ¡†æ¶ä¾èµ–
- âœ… å®ç°äº†çœŸæ­£çš„**å¯é€‰ä¾èµ–**ï¼Œè€Œä¸æ˜¯å¼ºåˆ¶ä¾èµ–

### 5.2 å°è£…åŸç”Ÿæ¥å£çš„å¼‚å¸¸å¤„ç†ï¼Œç»Ÿä¸€ä¸”ç®€åŒ–å¼‚å¸¸

#### 5.2.1 é—®é¢˜èƒŒæ™¯

åŸç”Ÿæ¡†æ¶æ¥å£ä¼šæŠ›å‡ºå¤šç§å¼‚å¸¸ï¼š
- **MyBatis å¼‚å¸¸**ï¼š`SqlSessionException`ã€`BindingException`ã€`PersistenceException` ç­‰
- **JPA å¼‚å¸¸**ï¼š`PersistenceException`ã€`EntityNotFoundException`ã€`TransactionRequiredException` ç­‰
- **åå°„å¼‚å¸¸**ï¼š`NoSuchMethodException`ã€`InvocationTargetException`ã€`IllegalAccessException` ç­‰

å¦‚æœç›´æ¥ä½¿ç”¨è¿™äº›æ¡†æ¶æ¥å£ï¼Œä¸Šå±‚ä»£ç éœ€è¦å¤„ç†å„ç§ä¸åŒçš„å¼‚å¸¸ç±»å‹ï¼Œä»£ç ä¼šå˜å¾—å¤æ‚ä¸”éš¾ä»¥ç»´æŠ¤ã€‚

#### 5.2.2 è§£å†³æ–¹æ¡ˆ

åŒ…è£…ç±»ç»Ÿä¸€æ•è·æ‰€æœ‰å¼‚å¸¸ï¼Œå¹¶è½¬æ¢ä¸ºé€šç”¨çš„ `RuntimeException`ï¼š

```java
private static class SqlSessionTemplateWrapper {
    public Connection getConnection() {
        try {
            return (Connection) sqlSessionTemplate.getClass()
                    .getMethod("getConnection")
                    .invoke(sqlSessionTemplate);
        } catch (Exception e) {  // â† ç»Ÿä¸€æ•è·æ‰€æœ‰å¼‚å¸¸
            // å°† MyBatis å¼‚å¸¸ã€åå°„å¼‚å¸¸ç»Ÿä¸€åŒ…è£…ä¸º RuntimeException
            throw new RuntimeException("è·å–è¿æ¥å¤±è´¥", e);
        }
    }
}
```

**ä¼˜åŠ¿**ï¼š
- âœ… **ç»Ÿä¸€å¼‚å¸¸ç±»å‹**ï¼šä¸Šå±‚ä»£ç åªéœ€å¤„ç† `RuntimeException`ï¼Œä¸éœ€è¦äº†è§£ MyBatis/JPA çš„å…·ä½“å¼‚å¸¸ç±»å‹
- âœ… **ç®€åŒ–å¼‚å¸¸å¤„ç†**ï¼šä¸šåŠ¡ä»£ç å¯ä»¥ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ï¼Œè€Œä¸æ˜¯æ¡†æ¶ç‰¹å®šçš„å¼‚å¸¸å¤„ç†
- âœ… **ä¿ç•™å¼‚å¸¸ä¿¡æ¯**ï¼šé€šè¿‡ `RuntimeException` çš„ `cause` ä¿ç•™åŸå§‹å¼‚å¸¸ä¿¡æ¯ï¼Œä¾¿äºè°ƒè¯•
- âœ… **é™ä½è€¦åˆåº¦**ï¼šä¸Šå±‚ä»£ç ä¸ä¾èµ–æ¡†æ¶çš„å¼‚å¸¸ç±»å‹ï¼Œé™ä½äº†ä¸æ¡†æ¶çš„è€¦åˆ

#### 5.2.3 å¯¹æ¯”ç¤ºä¾‹

**ä¸ä½¿ç”¨åŒ…è£…ç±»ï¼ˆå¤æ‚ï¼‰**ï¼š
```java
try {
    Connection conn = sqlSessionTemplate.getConnection();
    // ...
} catch (SqlSessionException e) {
    // å¤„ç† MyBatis å¼‚å¸¸
} catch (PersistenceException e) {
    // å¤„ç†æŒä¹…åŒ–å¼‚å¸¸
} catch (NoSuchMethodException e) {
    // å¤„ç†åå°„å¼‚å¸¸
} catch (InvocationTargetException e) {
    // å¤„ç†è°ƒç”¨å¼‚å¸¸
} catch (IllegalAccessException e) {
    // å¤„ç†è®¿é—®å¼‚å¸¸
}
```

**ä½¿ç”¨åŒ…è£…ç±»ï¼ˆç®€å•ï¼‰**ï¼š
```java
try {
    Connection conn = sqlSessionTemplateWrapper.getConnection();
    // ...
} catch (RuntimeException e) {
    // ç»Ÿä¸€å¤„ç†ï¼Œç®€å•æ˜äº†
    log.error("è·å–è¿æ¥å¤±è´¥", e);
}
```

### 5.3 æ‰©å±•æ—¶åªéœ€æ–°å¢ Wrapperï¼Œæ— éœ€ä¿®æ”¹åŸæœ‰ä»£ç ï¼ˆç¬¦åˆå¼€é—­åŸåˆ™ï¼‰

#### 5.3.1 å¼€é—­åŸåˆ™

**å¼€é—­åŸåˆ™ï¼ˆOpen-Closed Principleï¼‰**ï¼š
- **å¯¹æ‰©å±•å¼€æ”¾**ï¼šå¯ä»¥æ·»åŠ æ–°åŠŸèƒ½
- **å¯¹ä¿®æ”¹å…³é—­**ï¼šä¸éœ€è¦ä¿®æ”¹ç°æœ‰ä»£ç 

#### 5.3.2 å®é™…åº”ç”¨

å‡è®¾åç»­è¦æ”¯æŒ **Hibernate**ï¼Œåªéœ€è¦ï¼š

1. **æ–°å¢ Hibernate ç›¸å…³çš„ Wrapper**ï¼š
```java
// æ–°å¢ HibernateSessionWrapper
private static class HibernateSessionWrapper {
    private final Object session;
    
    public HibernateSessionWrapper(Object session) {
        this.session = session;
    }
    
    public Connection getConnection() {
        try {
            return (Connection) session.getClass()
                    .getMethod("connection")
                    .invoke(session);
        } catch (Exception e) {
            throw new RuntimeException("è·å–è¿æ¥å¤±è´¥", e);
        }
    }
}

// æ–°å¢ HibernateSessionFactoryWrapper
private static class HibernateSessionFactoryWrapper {
    private final Object sessionFactory;
    
    public HibernateSessionFactoryWrapper(Object sessionFactory) {
        this.sessionFactory = sessionFactory;
    }
    
    public HibernateSessionWrapper openSession() {
        try {
            Object session = sessionFactory.getClass()
                    .getMethod("openSession")
                    .invoke(sessionFactory);
            return new HibernateSessionWrapper(session);
        } catch (Exception e) {
            throw new RuntimeException("æ‰“å¼€ Session å¤±è´¥", e);
        }
    }
}
```

2. **æ–°å¢ HibernateDatabaseOperator**ï¼š
```java
public class HibernateDatabaseOperator implements DatabaseOperator {
    private final HibernateSessionFactoryWrapper sessionFactoryWrapper;
    
    public HibernateDatabaseOperator(Object sessionFactory, DataSource dataSource) {
        this.sessionFactoryWrapper = new HibernateSessionFactoryWrapper(sessionFactory);
        // ...
    }
    
    // å®ç° DatabaseOperator æ¥å£æ–¹æ³•
    // ...
}
```

3. **åœ¨å·¥å‚ç±»ä¸­æ³¨å†Œ**ï¼š
```java
public enum OperatorType {
    JDBC,
    JDBC_TEMPLATE,
    MYBATIS,
    JPA,
    HIBERNATE  // æ–°å¢
}

public DatabaseOperator createOperator(DataSource dataSource, OperatorType operatorType) {
    switch (operatorType) {
        // ... å…¶ä»– caseï¼ˆå®Œå…¨ä¸éœ€è¦ä¿®æ”¹ï¼‰
        case HIBERNATE:
            Object sessionFactory = applicationContext.getBean("sessionFactory");
            return new HibernateDatabaseOperator(sessionFactory, dataSource);
    }
}
```

**ä¼˜åŠ¿**ï¼š
- âœ… **åŸæœ‰ä»£ç å®Œå…¨ä¸éœ€è¦ä¿®æ”¹**ï¼š`MyBatisDatabaseOperator`ã€`JpaDatabaseOperator` ç­‰ä¿æŒä¸å˜
- âœ… **åªéœ€æ–°å¢ä»£ç **ï¼šæ–°å¢ `HibernateDatabaseOperator` å’Œç›¸å…³çš„ Wrapper ç±»
- âœ… **ç¬¦åˆå¼€é—­åŸåˆ™**ï¼šå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­
- âœ… **æ˜“äºç»´æŠ¤**ï¼šæ¯ä¸ªæ¡†æ¶çš„å®ç°ç›¸äº’ç‹¬ç«‹ï¼Œäº’ä¸å½±å“

#### 5.3.3 æ¶æ„ä¼˜åŠ¿

```
DatabaseOperator (æ¥å£)
â”œâ”€â”€ JdbcDatabaseOperator (JDBC å®ç°)          â† ä¸éœ€è¦ä¿®æ”¹
â”œâ”€â”€ JdbcTemplateDatabaseOperator (å®ç°)       â† ä¸éœ€è¦ä¿®æ”¹
â”œâ”€â”€ MyBatisDatabaseOperator (MyBatis å®ç°)    â† ä¸éœ€è¦ä¿®æ”¹
â”‚   â””â”€â”€ SqlSessionTemplateWrapper             â† ä¸éœ€è¦ä¿®æ”¹
â”‚   â””â”€â”€ SqlSessionFactoryWrapper              â† ä¸éœ€è¦ä¿®æ”¹
â”œâ”€â”€ JpaDatabaseOperator (JPA å®ç°)            â† ä¸éœ€è¦ä¿®æ”¹
â”‚   â””â”€â”€ EntityManagerWrapper                  â† ä¸éœ€è¦ä¿®æ”¹
â”‚   â””â”€â”€ EntityManagerFactoryWrapper           â† ä¸éœ€è¦ä¿®æ”¹
â””â”€â”€ HibernateDatabaseOperator (æ–°å¢)          â† åªéœ€æ–°å¢
    â””â”€â”€ HibernateSessionWrapper               â† åªéœ€æ–°å¢
    â””â”€â”€ HibernateSessionFactoryWrapper        â† åªéœ€æ–°å¢
```

### 5.4 ç±»å‹å®‰å…¨ä¸ä»£ç å¯è¯»æ€§

è™½ç„¶ä½¿ç”¨ `Object` ç±»å‹æ¥æ”¶æ¡†æ¶å®ä¾‹ï¼Œä½†é€šè¿‡åŒ…è£…ç±»æä¾›äº†**ç±»å‹å®‰å…¨çš„æ¥å£**ï¼š

```java
// åŒ…è£…ç±»æä¾›ç±»å‹å®‰å…¨çš„æ–¹æ³•ç­¾å
private static class SqlSessionTemplateWrapper {
    public Connection getConnection() {  // â† è¿”å› Connectionï¼Œç±»å‹æ˜ç¡®
        // ...
    }
    
    public SqlSessionWrapper getSqlSession() {  // â† è¿”å›åŒ…è£…ç±»ï¼Œç±»å‹æ˜ç¡®
        // ...
    }
}

// ä½¿ç”¨æ—¶ç±»å‹å®‰å…¨
Connection conn = sqlSessionTemplateWrapper.getConnection();  // â† ç±»å‹æ˜ç¡®ï¼ŒIDE å¯ä»¥è‡ªåŠ¨è¡¥å…¨
```

**ä¼˜åŠ¿**ï¼š
- âœ… **ç±»å‹å®‰å…¨**ï¼šè™½ç„¶å†…éƒ¨ä½¿ç”¨ `Object`ï¼Œä½†å¯¹å¤–æä¾›ç±»å‹æ˜ç¡®çš„æ¥å£
- âœ… **IDE æ”¯æŒ**ï¼šIDE å¯ä»¥è‡ªåŠ¨è¡¥å…¨ã€ç±»å‹æ£€æŸ¥ã€é‡æ„ç­‰
- âœ… **ä»£ç å¯è¯»æ€§**ï¼šæ–¹æ³•ç­¾åæ¸…æ™°ï¼Œæ˜“äºç†è§£å’Œä½¿ç”¨

### 5.5 æ€»ç»“

Wrapper åŒ…è£…ç±»è®¾è®¡æ¨¡å¼çš„æ ¸å¿ƒä¼˜åŠ¿ï¼š

| ä¼˜ç‚¹ | è¯´æ˜ | ä»·å€¼ |
|------|------|------|
| **ç¼–è¯‘æœŸæ— ä¾èµ–** | ç¼–è¯‘æ—¶ä¸éœ€è¦æ¡†æ¶ jar åŒ… | å®ç°çœŸæ­£çš„å¯é€‰ä¾èµ– |
| **è¿è¡ŒæœŸæŒ‰éœ€æä¾›** | è¿è¡Œæ—¶æ ¹æ®å®é™…éœ€è¦å¼•å…¥ä¾èµ– | çµæ´»é…ç½®ï¼Œé™ä½è€¦åˆ |
| **ç»Ÿä¸€å¼‚å¸¸å¤„ç†** | å°†æ¡†æ¶å¼‚å¸¸ç»Ÿä¸€ä¸º RuntimeException | ç®€åŒ–å¼‚å¸¸å¤„ç†ï¼Œé™ä½å¤æ‚åº¦ |
| **ç¬¦åˆå¼€é—­åŸåˆ™** | æ‰©å±•æ—¶åªéœ€æ–°å¢ï¼Œæ— éœ€ä¿®æ”¹åŸæœ‰ä»£ç  | æ˜“äºç»´æŠ¤å’Œæ‰©å±• |
| **ç±»å‹å®‰å…¨** | æä¾›ç±»å‹æ˜ç¡®çš„æ¥å£ | æé«˜ä»£ç å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ |

è¿™ç§è®¾è®¡ä½¿å¾— `common` æ¨¡å—å¯ä»¥åœ¨ä¸å¼ºåˆ¶ä¾èµ–ç‰¹å®šæ¡†æ¶çš„æƒ…å†µä¸‹ï¼Œçµæ´»åœ°æ”¯æŒå¤šç§æ•°æ®åº“æ“ä½œæ–¹å¼ï¼Œæ˜¯ä¸€ä¸ª**ä¼˜é›…ä¸”å®ç”¨çš„æ¶æ„è®¾è®¡**ã€‚

---

## å…­ã€æ‰©å±•æ–°çš„æ“ä½œå™¨ï¼ˆç¤ºä¾‹ï¼‰

### 6.1 å®ç° DatabaseOperator æ¥å£

ä»¥ `JpaDatabaseOperator` ä¸ºä¾‹ï¼ˆå·²å®ç°ï¼‰ï¼š

```java
public class JpaDatabaseOperator implements DatabaseOperator {
    
    // ä½¿ç”¨åŒ…è£…ç±»ï¼Œé¿å…ç›´æ¥ä¾èµ– JPAè§„èŒƒ.md ç±»å‹
    private final EntityManagerWrapper entityManagerWrapper;
    private final EntityManagerFactoryWrapper entityManagerFactoryWrapper;
    
    // æ„é€ å‡½æ•°æ¥æ”¶ Object ç±»å‹ï¼Œç¼–è¯‘æœŸæ— ä¾èµ–
    public JpaDatabaseOperator(Object entityManager,
                               Object entityManagerFactory,
                               DataSource dataSource) {
        this.entityManagerWrapper = new EntityManagerWrapper(entityManager);
        this.entityManagerFactoryWrapper = new EntityManagerFactoryWrapper(entityManagerFactory);
        // ...
    }
    
    @Override
    public Connection getConnection() throws Exception {
        // é€šè¿‡åŒ…è£…ç±»è·å–è¿æ¥
        return entityManagerWrapper.unwrap(Connection.class);
    }
    
    @Override
    public int executeUpdate(String sql, Object... params) throws Exception {
        // é€šè¿‡åŒ…è£…ç±»æ‰§è¡Œæ›´æ–°
        QueryWrapper query = entityManagerWrapper.createNativeQuery(sql);
        for (int i = 0; i < params.length; i++) {
            query.setParameter(i + 1, params[i]);
        }
        return query.executeUpdate();
    }
    
    // å®ç°å…¶ä»–æ–¹æ³•...
}
```

### 6.2 åœ¨å·¥å‚ç±»ä¸­æ³¨å†Œ

```java
public enum OperatorType {
    JDBC,
    JDBC_TEMPLATE,
    MYBATIS,
    JPA  // æ–°å¢
}

public DatabaseOperator createOperator(DataSource dataSource, OperatorType operatorType) {
    switch (operatorType) {
        // ... å…¶ä»– case
        case JPA:
            EntityManager entityManager = applicationContext.getBean(EntityManager.class);
            return new JpaDatabaseOperator(entityManager);
    }
}
```

### 6.3 åœ¨é…ç½®ä¸­ä½¿ç”¨

```java
.operatorType(MigrationConfig.DataSourceConfig.OperatorType.JPA)
```

---

## ä¸ƒã€æ€§èƒ½å¯¹æ¯”

| æ“ä½œæ–¹å¼ | æ€§èƒ½ | æ˜“ç”¨æ€§ | åŠŸèƒ½ä¸°å¯Œåº¦ |
|---------|------|--------|-----------|
| **JDBC** | â­â­â­â­â­ | â­â­ | â­â­ |
| **JDBC Template** | â­â­â­â­ | â­â­â­â­ | â­â­â­ |
| **MyBatis** | â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ |

**å»ºè®®**ï¼š
- **æ€§èƒ½ä¼˜å…ˆ**ï¼šä½¿ç”¨ JDBC
- **å¼€å‘æ•ˆç‡ä¼˜å…ˆ**ï¼šä½¿ç”¨ JDBC Template æˆ– MyBatis
- **å·²æœ‰æ¡†æ¶**ï¼šä½¿ç”¨å¯¹åº”çš„æ“ä½œå™¨ç±»å‹

---

## å…«ã€å®Œæ•´ç¤ºä¾‹

### 7.1 ä½¿ç”¨ JDBC

```java
MigrationConfig config = MigrationConfig.builder()
        .source(MigrationConfig.DataSourceConfig.builder()
                .dataSource(sourceDataSource)
                .operatorType(MigrationConfig.DataSourceConfig.OperatorType.JDBC)
                .build())
        .target(MigrationConfig.DataSourceConfig.builder()
                .dataSource(targetDataSource)
                .operatorType(MigrationConfig.DataSourceConfig.OperatorType.JDBC)
                .build())
        .build();
```

### 7.2 ä½¿ç”¨ MyBatis

```java
MigrationConfig config = MigrationConfig.builder()
        .source(MigrationConfig.DataSourceConfig.builder()
                .dataSource(sourceDataSource)
                .operatorType(MigrationConfig.DataSourceConfig.OperatorType.MYBATIS)
                .build())
        .target(MigrationConfig.DataSourceConfig.builder()
                .dataSource(targetDataSource)
                .operatorType(MigrationConfig.DataSourceConfig.OperatorType.MYBATIS)
                .build())
        .build();
```

### 7.3 æ··åˆä½¿ç”¨

```java
// æºåº“ä½¿ç”¨ JDBCï¼ˆæ€§èƒ½ä¼˜å…ˆï¼‰
// ç›®æ ‡åº“ä½¿ç”¨ MyBatisï¼ˆåˆ©ç”¨ç°æœ‰é…ç½®ï¼‰
MigrationConfig config = MigrationConfig.builder()
        .source(MigrationConfig.DataSourceConfig.builder()
                .dataSource(sourceDataSource)
                .operatorType(MigrationConfig.DataSourceConfig.OperatorType.JDBC)
                .build())
        .target(MigrationConfig.DataSourceConfig.builder()
                .dataSource(targetDataSource)
                .operatorType(MigrationConfig.DataSourceConfig.OperatorType.MYBATIS)
                .build())
        .build();
```

---

## ä¹ã€æ€»ç»“

### 8.1 ä¼˜åŠ¿

âœ… **çµæ´»æ€§**ï¼šæ”¯æŒå¤šç§æ•°æ®åº“æ“ä½œæ–¹å¼  
âœ… **å¯æ‰©å±•**ï¼šæ˜“äºæ·»åŠ æ–°çš„æ“ä½œå™¨å®ç°  
âœ… **å…¼å®¹æ€§**ï¼šå‘åå…¼å®¹ï¼Œé»˜è®¤ä½¿ç”¨ JDBC  
âœ… **é™çº§ç­–ç•¥**ï¼šMyBatis æœªé…ç½®æ—¶è‡ªåŠ¨é™çº§  

### 8.2 ä½¿ç”¨å»ºè®®

1. **é»˜è®¤æƒ…å†µ**ï¼šä½¿ç”¨ JDBCï¼ˆæ€§èƒ½æœ€å¥½ï¼‰
2. **Spring é¡¹ç›®**ï¼šå¯ä»¥ä½¿ç”¨ JDBC Template
3. **MyBatis é¡¹ç›®**ï¼šå¯ä»¥ä½¿ç”¨ MyBatis æ“ä½œå™¨
4. **æ€§èƒ½è¦æ±‚é«˜**ï¼šä½¿ç”¨ JDBC
5. **å¼€å‘æ•ˆç‡ä¼˜å…ˆ**ï¼šä½¿ç”¨ JDBC Template æˆ– MyBatis

### 8.3 åç»­æ‰©å±•

å¯ä»¥ç»§ç»­æ‰©å±•æ”¯æŒï¼š
- JPA/Hibernate
- Spring Data JPA
- å…¶ä»– ORM æ¡†æ¶

---

**ç°åœ¨æ“ä½œç›®æ ‡æ•°æ®åº“ä¸å†å±€é™äº JDBC åŸç”Ÿæ¥å£ï¼Œå¯ä»¥æ ¹æ®é¡¹ç›®æƒ…å†µé€‰æ‹©æœ€é€‚åˆçš„æ“ä½œæ–¹å¼ï¼** ğŸ‰

