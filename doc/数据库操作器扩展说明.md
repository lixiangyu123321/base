# æ•°æ®åº“æ“ä½œå™¨æ‰©å±•è¯´æ˜

## æ–‡æ¡£ä¿¡æ¯

- **åˆ›å»ºæ—¥æœŸ**: 2025-01-27
- **åŠŸèƒ½æ¨¡å—**: `com.lixiangyu.common.migration.operator`
- **ç‰ˆæœ¬**: 2.0

---

## ä¸€ã€é—®é¢˜è¯´æ˜

### 1.1 åŸæœ‰å®ç°

åŸæœ‰çš„ `DataMigrationService` åªæ”¯æŒ **JDBC åŸç”Ÿæ¥å£**æ“ä½œæ•°æ®åº“ï¼š

```java
// åŸæœ‰å®ç°ï¼šåªèƒ½ä½¿ç”¨ JDBC åŸç”Ÿæ¥å£
try (Connection conn = dataSource.getConnection();
     PreparedStatement stmt = conn.prepareStatement(sql)) {
    // æ“ä½œæ•°æ®åº“
}
```

**å±€é™æ€§**ï¼š
- âŒ åªèƒ½ä½¿ç”¨ JDBC åŸç”Ÿæ¥å£
- âŒ æ— æ³•åˆ©ç”¨ MyBatis çš„ç‰¹æ€§
- âŒ æ— æ³•ä½¿ç”¨ Spring JDBC Template çš„ä¾¿åˆ©æ€§
- âŒ æ‰©å±•æ€§å·®

### 1.2 æ‰©å±•æ–¹æ¡ˆ

é€šè¿‡**ç­–ç•¥æ¨¡å¼**å’Œ**å·¥å‚æ¨¡å¼**ï¼Œæ”¯æŒå¤šç§æ•°æ®åº“æ“ä½œæ–¹å¼ï¼š

| æ“ä½œæ–¹å¼ | å®ç°ç±» | è¯´æ˜ |
|---------|--------|------|
| **JDBC** | `JdbcDatabaseOperator` | JDBC åŸç”Ÿæ¥å£ï¼ˆé»˜è®¤ï¼‰ |
| **JDBC Template** | `JdbcTemplateDatabaseOperator` | Spring JDBC Template |
| **MyBatis** | `MyBatisDatabaseOperator` | MyBatis SqlSession |

---

## äºŒã€æ¶æ„è®¾è®¡

### 2.1 ç±»ç»“æ„

```
DatabaseOperator (æ¥å£)
â”œâ”€â”€ JdbcDatabaseOperator (JDBC å®ç°)
â”œâ”€â”€ JdbcTemplateDatabaseOperator (JdbcTemplate å®ç°)
â””â”€â”€ MyBatisDatabaseOperator (MyBatis å®ç°)

DatabaseOperatorFactory (å·¥å‚ç±»)
â””â”€â”€ æ ¹æ®é…ç½®åˆ›å»ºä¸åŒçš„æ“ä½œå™¨
```

### 2.2 æ ¸å¿ƒæ¥å£

```java
public interface DatabaseOperator {
    Connection getConnection();
    ResultSet executeQuery(String sql, Object... params);
    int executeUpdate(String sql, Object... params);
    int[] executeBatch(String sql, List<Object[]> batchParams);
    long getRecordCount(String tableName);
    TableStructure getTableStructure(String tableName);
    void createTable(String tableName, TableStructure structure);
    void truncateTable(String tableName);
    List<String> getPrimaryKeys(String tableName);
}
```

---

## ä¸‰ã€ä½¿ç”¨æ–¹å¼

### 3.1 é…ç½®æ“ä½œå™¨ç±»å‹

```java
MigrationConfig config = MigrationConfig.builder()
        .source(MigrationConfig.DataSourceConfig.builder()
                .dataSource(sourceDataSource)
                .operatorType(MigrationConfig.DataSourceConfig.OperatorType.JDBC)  // JDBC
                .build())
        .target(MigrationConfig.DataSourceConfig.builder()
                .dataSource(targetDataSource)
                .operatorType(MigrationConfig.DataSourceConfig.OperatorType.MYBATIS)  // MyBatis
                .build())
        .build();
```

### 3.2 æ“ä½œå™¨ç±»å‹è¯´æ˜

#### 3.2.1 JDBCï¼ˆé»˜è®¤ï¼‰

**ç‰¹ç‚¹**ï¼š
- âœ… æœ€åº•å±‚ï¼Œæ€§èƒ½æœ€å¥½
- âœ… ä¸ä¾èµ–å…¶ä»–æ¡†æ¶
- âŒ ä»£ç è¾ƒç¹ç

**é€‚ç”¨åœºæ™¯**ï¼š
- æ€§èƒ½è¦æ±‚é«˜çš„åœºæ™¯
- ä¸éœ€è¦ ORM æ¡†æ¶çš„åœºæ™¯

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
.operatorType(MigrationConfig.DataSourceConfig.OperatorType.JDBC)
```

#### 3.2.2 JDBC Template

**ç‰¹ç‚¹**ï¼š
- âœ… Spring æä¾›ï¼Œä½¿ç”¨æ–¹ä¾¿
- âœ… è‡ªåŠ¨å¤„ç†èµ„æºç®¡ç†
- âœ… æ”¯æŒå‘½åå‚æ•°

**é€‚ç”¨åœºæ™¯**ï¼š
- ä½¿ç”¨ Spring æ¡†æ¶çš„é¡¹ç›®
- éœ€è¦ç®€åŒ– JDBC ä»£ç çš„åœºæ™¯

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
.operatorType(MigrationConfig.DataSourceConfig.OperatorType.JDBC_TEMPLATE)
```

#### 3.2.3 MyBatis

**ç‰¹ç‚¹**ï¼š
- âœ… å¯ä»¥åˆ©ç”¨ MyBatis çš„ç‰¹æ€§
- âœ… æ”¯æŒ Mapper XML
- âœ… æ”¯æŒåŠ¨æ€ SQL

**é€‚ç”¨åœºæ™¯**ï¼š
- é¡¹ç›®å·²ä½¿ç”¨ MyBatis
- éœ€è¦åˆ©ç”¨ MyBatis ç‰¹æ€§çš„åœºæ™¯

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
.operatorType(MigrationConfig.DataSourceConfig.OperatorType.MYBATIS)
```

**æ³¨æ„**ï¼šå¦‚æœ MyBatis æœªé…ç½®ï¼Œä¼šè‡ªåŠ¨é™çº§ä¸º `JdbcTemplateDatabaseOperator`ã€‚

---

## å››ã€å®ç°ç»†èŠ‚

### 4.1 å·¥å‚æ¨¡å¼

```java
@Component
public class DatabaseOperatorFactory {
    
    public DatabaseOperator createOperator(DataSource dataSource, OperatorType operatorType) {
        switch (operatorType) {
            case JDBC:
                return new JdbcDatabaseOperator(dataSource);
            case JDBC_TEMPLATE:
                return new JdbcTemplateDatabaseOperator(dataSource);
            case MYBATIS:
                // å°è¯•è·å– MyBatis Beanï¼Œå¤±è´¥åˆ™é™çº§
                return new MyBatisDatabaseOperator(...);
            default:
                return new JdbcDatabaseOperator(dataSource);
        }
    }
}
```

### 4.2 ç­–ç•¥æ¨¡å¼

`DataMigrationService` ä½¿ç”¨ `DatabaseOperator` æ¥å£ï¼Œä¸å…³å¿ƒå…·ä½“å®ç°ï¼š

```java
// è·å–æ“ä½œå™¨
DatabaseOperator sourceOperator = factory.createOperator(
        sourceDataSource, 
        config.getSource().getOperatorType()
);

DatabaseOperator targetOperator = factory.createOperator(
        targetDataSource, 
        config.getTarget().getOperatorType()
);

// ä½¿ç”¨æ“ä½œå™¨ï¼ˆä¸å…³å¿ƒå…·ä½“å®ç°ï¼‰
long count = sourceOperator.getRecordCount(tableName);
targetOperator.createTable(tableName, structure);
```

---

## äº”ã€æ‰©å±•æ–°çš„æ“ä½œå™¨

### 5.1 å®ç° DatabaseOperator æ¥å£

```java
@Component
public class JpaDatabaseOperator implements DatabaseOperator {
    
    private final EntityManager entityManager;
    
    @Override
    public Connection getConnection() throws Exception {
        return entityManager.unwrap(Connection.class);
    }
    
    @Override
    public int executeUpdate(String sql, Object... params) throws Exception {
        Query query = entityManager.createNativeQuery(sql);
        for (int i = 0; i < params.length; i++) {
            query.setParameter(i + 1, params[i]);
        }
        return query.executeUpdate();
    }
    
    // å®ç°å…¶ä»–æ–¹æ³•...
}
```

### 5.2 åœ¨å·¥å‚ç±»ä¸­æ³¨å†Œ

```java
public enum OperatorType {
    JDBC,
    JDBC_TEMPLATE,
    MYBATIS,
    JPA  // æ–°å¢
}

public DatabaseOperator createOperator(DataSource dataSource, OperatorType operatorType) {
    switch (operatorType) {
        // ... å…¶ä»– case
        case JPA:
            EntityManager entityManager = applicationContext.getBean(EntityManager.class);
            return new JpaDatabaseOperator(entityManager);
    }
}
```

### 5.3 åœ¨é…ç½®ä¸­ä½¿ç”¨

```java
.operatorType(MigrationConfig.DataSourceConfig.OperatorType.JPA)
```

---

## å…­ã€æ€§èƒ½å¯¹æ¯”

| æ“ä½œæ–¹å¼ | æ€§èƒ½ | æ˜“ç”¨æ€§ | åŠŸèƒ½ä¸°å¯Œåº¦ |
|---------|------|--------|-----------|
| **JDBC** | â­â­â­â­â­ | â­â­ | â­â­ |
| **JDBC Template** | â­â­â­â­ | â­â­â­â­ | â­â­â­ |
| **MyBatis** | â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ |

**å»ºè®®**ï¼š
- **æ€§èƒ½ä¼˜å…ˆ**ï¼šä½¿ç”¨ JDBC
- **å¼€å‘æ•ˆç‡ä¼˜å…ˆ**ï¼šä½¿ç”¨ JDBC Template æˆ– MyBatis
- **å·²æœ‰æ¡†æ¶**ï¼šä½¿ç”¨å¯¹åº”çš„æ“ä½œå™¨ç±»å‹

---

## ä¸ƒã€å®Œæ•´ç¤ºä¾‹

### 7.1 ä½¿ç”¨ JDBC

```java
MigrationConfig config = MigrationConfig.builder()
        .source(MigrationConfig.DataSourceConfig.builder()
                .dataSource(sourceDataSource)
                .operatorType(MigrationConfig.DataSourceConfig.OperatorType.JDBC)
                .build())
        .target(MigrationConfig.DataSourceConfig.builder()
                .dataSource(targetDataSource)
                .operatorType(MigrationConfig.DataSourceConfig.OperatorType.JDBC)
                .build())
        .build();
```

### 7.2 ä½¿ç”¨ MyBatis

```java
MigrationConfig config = MigrationConfig.builder()
        .source(MigrationConfig.DataSourceConfig.builder()
                .dataSource(sourceDataSource)
                .operatorType(MigrationConfig.DataSourceConfig.OperatorType.MYBATIS)
                .build())
        .target(MigrationConfig.DataSourceConfig.builder()
                .dataSource(targetDataSource)
                .operatorType(MigrationConfig.DataSourceConfig.OperatorType.MYBATIS)
                .build())
        .build();
```

### 7.3 æ··åˆä½¿ç”¨

```java
// æºåº“ä½¿ç”¨ JDBCï¼ˆæ€§èƒ½ä¼˜å…ˆï¼‰
// ç›®æ ‡åº“ä½¿ç”¨ MyBatisï¼ˆåˆ©ç”¨ç°æœ‰é…ç½®ï¼‰
MigrationConfig config = MigrationConfig.builder()
        .source(MigrationConfig.DataSourceConfig.builder()
                .dataSource(sourceDataSource)
                .operatorType(MigrationConfig.DataSourceConfig.OperatorType.JDBC)
                .build())
        .target(MigrationConfig.DataSourceConfig.builder()
                .dataSource(targetDataSource)
                .operatorType(MigrationConfig.DataSourceConfig.OperatorType.MYBATIS)
                .build())
        .build();
```

---

## å…«ã€æ€»ç»“

### 8.1 ä¼˜åŠ¿

âœ… **çµæ´»æ€§**ï¼šæ”¯æŒå¤šç§æ•°æ®åº“æ“ä½œæ–¹å¼  
âœ… **å¯æ‰©å±•**ï¼šæ˜“äºæ·»åŠ æ–°çš„æ“ä½œå™¨å®ç°  
âœ… **å…¼å®¹æ€§**ï¼šå‘åå…¼å®¹ï¼Œé»˜è®¤ä½¿ç”¨ JDBC  
âœ… **é™çº§ç­–ç•¥**ï¼šMyBatis æœªé…ç½®æ—¶è‡ªåŠ¨é™çº§  

### 8.2 ä½¿ç”¨å»ºè®®

1. **é»˜è®¤æƒ…å†µ**ï¼šä½¿ç”¨ JDBCï¼ˆæ€§èƒ½æœ€å¥½ï¼‰
2. **Spring é¡¹ç›®**ï¼šå¯ä»¥ä½¿ç”¨ JDBC Template
3. **MyBatis é¡¹ç›®**ï¼šå¯ä»¥ä½¿ç”¨ MyBatis æ“ä½œå™¨
4. **æ€§èƒ½è¦æ±‚é«˜**ï¼šä½¿ç”¨ JDBC
5. **å¼€å‘æ•ˆç‡ä¼˜å…ˆ**ï¼šä½¿ç”¨ JDBC Template æˆ– MyBatis

### 8.3 åç»­æ‰©å±•

å¯ä»¥ç»§ç»­æ‰©å±•æ”¯æŒï¼š
- JPA/Hibernate
- Spring Data JPA
- å…¶ä»– ORM æ¡†æ¶

---

**ç°åœ¨æ“ä½œç›®æ ‡æ•°æ®åº“ä¸å†å±€é™äº JDBC åŸç”Ÿæ¥å£ï¼Œå¯ä»¥æ ¹æ®é¡¹ç›®æƒ…å†µé€‰æ‹©æœ€é€‚åˆçš„æ“ä½œæ–¹å¼ï¼** ğŸ‰

